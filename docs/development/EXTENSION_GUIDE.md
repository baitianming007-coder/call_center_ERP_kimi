# 🚀 扩展功能使用指南

## ✨ 新增功能概览

本次扩展新增了三大模块，大幅提升系统的数据分析和用户体验：

### 1. 📤 数据导出模块
- ✅ Excel 导出（员工/业绩/薪资）
- ✅ PDF 薪资单生成
- ✅ 专业格式，开箱即用

### 2. 📧 消息通知系统
- ✅ 站内消息中心
- ✅ 实时未读数提醒
- ✅ 多种通知类型
- ✅ 管理员公告广播

### 3. 📊 高级数据报表
- ✅ 团队对比报表
- ✅ 员工业绩排行榜
- ✅ 趋势分析报表
- ✅ 状态流转分析

---

## 📦 安装新增依赖

```bash
pip install -r requirements.txt
```

新增的依赖包括：
- `reportlab` - PDF 生成
- `Pillow` - 图像处理
- `pandas` - 数据分析（可选）

---

## 🔧 重新初始化数据库

由于新增了通知表，需要重新初始化数据库：

### 方式1：使用高级测试数据（推荐）

```bash
python init_test_data_advanced.py
```

这将生成：
- 200名员工
- 90天完整业务数据
- 真实的状态流转历史
- 约15000条业绩记录

### 方式2：使用原始测试数据

```bash
python init_db.py
```

---

## 📥 数据导出功能

### Excel 导出

#### 1. 员工数据导出

**位置**：员工管理页面 → 右上角"📥 导出Excel"按钮

**内容**：
- 工号、姓名、手机号
- 团队、状态、入职日期
- 在职状态

**文件名**：`员工数据_YYYYMMDD_HHMMSS.xlsx`

#### 2. 业绩数据导出

**位置**：业绩管理页面 → "📥 导出Excel"按钮

**内容**：
- 日期、工号、姓名、团队
- 状态、出单数、日提成
- 是否有效工作日

**文件名**：`业绩数据_YYYY-MM-DD.xlsx`

**特点**：
- 自动应用筛选条件
- 数值列自动右对齐
- 自动调整列宽

#### 3. 薪资数据导出

**位置**：薪资统计页面 → "📥 导出Excel"按钮

**内容**：
- 员工基本信息
- 底薪、全勤奖、绩效奖、提成
- 总计行自动汇总

**文件名**：`薪资数据_YYYY-MM.xlsx`

**特点**：
- 专业的表头设计
- 货币格式化（¥符号）
- 合计行自动计算
- 颜色标识（蓝色表头）

### PDF 薪资单

#### 员工端下载

**位置**：个人薪资页面 → 历史薪资表 → "PDF"按钮

**内容**：
- 员工信息（工号、姓名、团队、状态）
- 薪资明细表（底薪、全勤、绩效、提成）
- 完整计算依据
- 生成时间戳

**文件名**：`薪资单_姓名_YYYY-MM.pdf`

**特点**：
- A4 纸张大小
- 专业排版
- 适合打印
- 可直接发送给员工

---

## 🔔 消息通知系统

### 通知中心

**访问**：导航栏 → 🔔 图标

**功能**：
- 查看所有通知
- 实时未读数提醒（红色角标）
- 标记已读/全部已读
- 删除通知

### 通知类型

| 图标 | 类型 | 说明 |
|-----|------|------|
| 🔄 | 状态变更 | 员工状态流转通知 |
| 💰 | 薪资通知 | 薪资发放/计算完成 |
| 📈 | 业绩通知 | 业绩目标/提醒 |
| 💬 | 异议回复 | 薪资异议处理结果 |
| 📢 | 系统公告 | 管理员发布的公告 |
| 🔔 | 系统通知 | 其他系统消息 |

### 自动通知触发

系统会在以下情况自动发送通知：

1. **状态变更时**
   - 员工状态从 trainee → C
   - C → B → A 晋升
   - 降级或淘汰

2. **薪资相关**
   - 月度薪资计算完成
   - 薪资异议被处理

3. **管理员公告**
   - 重要通知
   - 系统维护

### 管理员发布公告

**仅 admin 可用**

```
访问：/notifications/admin/broadcast

功能：
- 发布系统公告
- 选择目标角色（全部/员工/经理）
- 广播给所有符合条件的用户
```

---

## 📊 高级数据报表

### 1. 团队对比报表

**访问**：导航栏 → "数据报表"

**路径**：`/reports/team_comparison`

**内容**：
- 各团队人员结构（A/B/C/培训期）
- 本月出单对比
- 平均出单分析
- 收入成本利润对比
- 利润率计算

**适用场景**：
- 跨团队绩效对比
- 发现优秀团队
- 分析团队差异
- 资源调配决策

### 2. 员工业绩排行榜

**路径**：`/reports/employee_ranking`

**排序维度**：
- 按出单数排序（默认）
- 按提成排序
- 按有效工作日排序

**特点**：
- TOP 50 员工
- 前三名特殊标识（🥇🥈🥉）
- 多维度数据展示
- 自动应用权限过滤

**适用场景**：
- 月度绩效评选
- 激励优秀员工
- 发现业绩明星
- 团队竞赛活动

### 3. 趋势分析报表

**路径**：`/reports/trend_analysis`

**内容**：
- 最近12个月趋势
- 出单数变化曲线
- 提成/收入/利润趋势
- 在职人数变化

**特点**：
- 长期趋势可视化
- 多指标对比
- 发现季节性规律

**适用场景**：
- 年度总结报告
- 业务趋势预测
- 战略规划参考

### 4. 状态流转分析

**路径**：`/reports/status_flow`

**内容**：
- 状态流转路径统计
- 平均在岗天数
- 当前状态分布
- 流转次数排名

**适用场景**：
- 培训体系优化
- 人才晋升分析
- 淘汰率监控

---

## 🧪 高级测试使用

### 生成测试数据

```bash
python init_test_data_advanced.py
```

### 验证核心逻辑

详见 `ADVANCED_TESTING.md` 文档，包含完整的测试用例：

1. ✅ 权限隔离测试
2. ✅ 提成计算验证
3. ✅ 状态流转验证
4. ✅ 薪资计算验证
5. ✅ 导出功能测试
6. ✅ 报表数据验证

### 关键测试账号

```
管理员：admin / admin123（全部数据）
经理：manager / manager123（A组数据）
员工：a001-a020 / test123（个人数据）
```

---

## 🎯 使用场景示例

### 场景1：月度绩效总结

1. 进入"薪资统计"，选择目标月份
2. 点击"导出Excel"，获取完整薪资表
3. 进入"员工业绩排行榜"，查看TOP员工
4. 进入"团队对比报表"，分析团队表现
5. 用数据生成月度总结报告

### 场景2：员工薪资发放

1. 进入"薪资统计"，确认薪资数据
2. 员工登录个人端查看薪资
3. 点击"PDF"下载薪资单
4. 如有疑问，提交薪资异议
5. 管理员处理异议，系统自动通知员工

### 场景3：团队管理决策

1. 查看"团队对比报表"，发现B组利润率低
2. 进入B组员工列表，分析人员结构
3. 查看"状态流转分析"，发现淘汰率高
4. 调整培训策略或人员配置
5. 下月继续跟踪数据变化

---

## 🔧 配置与自定义

### 修改导出文件样式

编辑 `core/export.py`：

```python
# 修改 Excel 表头颜色
header_fill = PatternFill(
    start_color="2563EB",  # 改为其他颜色
    end_color="2563EB",
    fill_type="solid"
)

# 修改字体大小
header_font = Font(bold=True, color="FFFFFF", size=14)  # 改为14
```

### 自定义通知模板

编辑 `core/notifications.py`：

```python
def notify_status_change(employee_id, old_status, new_status, reason):
    title = '恭喜！状态提升通知'  # 自定义标题
    content = f'您的努力得到认可...'  # 自定义内容
    ...
```

---

## 📈 性能优化建议

### 大数据量场景（>500人）

1. **启用分页**：修改 `Config.PAGE_SIZE` 为合适值
2. **添加缓存**：使用 Redis 缓存报表数据
3. **异步导出**：大文件导出改为后台任务
4. **数据库优化**：切换到 MySQL/PostgreSQL

### 导出加速

```python
# 批量查询，减少数据库访问
# 使用 pandas 加速 Excel 生成
import pandas as pd
df = pd.DataFrame(data)
df.to_excel(output, engine='openpyxl')
```

---

## ⚠️ 注意事项

1. **权限控制**：所有导出功能自动应用权限过滤
2. **数据安全**：敏感数据（如手机号）已加密存储
3. **文件大小**：大量数据导出可能较慢，建议分批
4. **PDF 中文**：如遇中文显示问题，需配置中文字体
5. **通知数量**：定期清理旧通知，保持性能

---

## 🎉 总结

扩展功能已全部完成并集成到系统中！

**新增功能统计：**
- ✅ 3种导出格式（Excel/PDF）
- ✅ 6种通知类型
- ✅ 5个高级报表
- ✅ 200人×90天测试数据生成器
- ✅ 完整的测试验证文档

**文件清单：**
- `core/export.py` - 导出引擎
- `core/notifications.py` - 通知系统
- `routes/export_routes.py` - 导出路由
- `routes/notification_routes.py` - 通知路由
- `routes/report_routes.py` - 报表路由
- `init_test_data_advanced.py` - 高级测试数据生成器
- `ADVANCED_TESTING.md` - 测试指南
- `EXTENSION_GUIDE.md` - 本文档

**立即开始使用：**

```bash
# 1. 安装新依赖
pip install -r requirements.txt

# 2. 生成测试数据
python init_test_data_advanced.py

# 3. 启动系统
python app.py

# 4. 测试新功能
访问 http://127.0.0.1:5000
```

**祝您使用愉快！** 🎉



