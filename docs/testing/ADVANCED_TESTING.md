# 🧪 高级测试指南

## 🎯 测试目标

验证系统在大规模数据和真实业务场景下的核心逻辑准确性：
- ✅ 200名员工
- ✅ 90天业务数据
- ✅ 动态状态流转（trainee → C → B → A）
- ✅ 每日随机出单（0-5单）
- ✅ 完整的状态变更历史

---

## 📦 生成高级测试数据

### 运行测试数据生成器

```bash
python init_test_data_advanced.py
```

**输出示例：**
```
======================================================================
高级测试数据生成器 - 200名员工 × 90天动态模拟
======================================================================

[1/5] 清理旧测试数据...
✓ 旧数据已清理

[2/5] 创建200名员工...
✓ 已创建200名员工，分布在4个团队
  - 入职时间范围：2024-07-16 ~ 2024-10-15

[3/5] 模拟90天业绩数据和状态流转...
  这个过程会模拟真实的业务场景：
  - 每天随机出单 0-5 单
  - 根据规则自动流转状态
  - 记录所有状态变更历史
  处理日期: 2024-10-14 (剩余0天)
    → A012 C→A: 9天内最近6天出单≥12单（实际15单）
    → B045 B→A: 9天内最近6天出单≥12单（实际13单）
✓ 业绩模拟完成
  - 生成业绩记录：15234 条
  - 状态变更次数：543 次

[4/5] 统计员工状态分布...
  最终状态分布：
    A级   :  38人 ( 19.0%)
    B级   :  52人 ( 26.0%)
    C级   :  67人 ( 33.5%)
    培训期:  28人 ( 14.0%)
    已淘汰:  15人 (  7.5%)

[5/5] 验证核心业务逻辑...
  ✓ 验证提成计算（随机抽样5条）：
    ✓ 3单 → ¥30.00 (预期¥30.00)
    ✓ 5单 → ¥70.00 (预期¥70.00)
    ✓ 2单 → ¥20.00 (预期¥20.00)
    ✓ 4单 → ¥50.00 (预期¥50.00)
    ✓ 1单 → ¥10.00 (预期¥10.00)
  ✓ 验证状态流转路径：
    trainee → C: 172 次
    C → B:       89 次
    B → A:       45 次
  ✓ 验证A级员工达标情况（随机抽样3人）：
    ✓ A012 最近6天出单: 15单
    ✓ A045 最近6天出单: 13单
    ✓ A078 最近6天出单: 14单

======================================================================
✅ 高级测试数据生成完成！
======================================================================
```

---

## 🧩 核心测试用例

### 测试1：登录不同角色，验证数据隔离

#### 1.1 管理员账号（admin / admin123）

```
预期结果：
✅ 能看到全部4个团队的数据
✅ 主看板显示200名员工统计
✅ 能访问所有管理功能
```

**测试步骤：**
1. 登录后查看主看板
2. 验证"在职人数"显示200人
3. 查看"人员状态分布"饼图，确认比例正确
4. 进入"员工管理"，能看到所有团队员工

#### 1.2 经理账号（manager / manager123）

```
预期结果：
✅ 仅能看到A组数据
✅ 无法访问团队管理
✅ 无法访问账号管理
```

**测试步骤：**
1. 登录后查看主看板
2. 注意顶部显示"数据范围：A组"
3. 进入"员工管理"，仅显示A组员工
4. 尝试访问 `/admin/teams`，应被拒绝

#### 1.3 员工账号（a001 / test123）

```
预期结果：
✅ 仅能看到个人数据
✅ 无法访问管理端
✅ 可以查看个人业绩和薪资
```

**测试步骤：**
1. 登录后自动跳转到"个人业绩"
2. 查看今日出单、本月累计
3. 查看最近7天趋势图
4. 尝试访问 `/admin/dashboard`，应被跳转

---

### 测试2：录入业绩，验证提成计算

**测试步骤：**
1. 用管理员登录
2. 进入"业绩管理" → "单条录入"
3. 选择任意员工，日期选择今天
4. 依次输入不同出单数，观察提成预览：

| 出单数 | 预期提成 | 计算公式 |
|-------|---------|---------|
| 1单 | ¥10.00 | 1×10 |
| 3单 | ¥30.00 | 3×10 |
| 4单 | ¥50.00 | 3×10 + 1×20 |
| 5单 | ¥70.00 | 3×10 + 2×20 |
| 6单 | ¥100.00 | 3×10 + 2×20 + 1×30 |
| 7单 | ¥130.00 | 3×10 + 2×20 + 2×30 |

**批量录入测试：**
1. 进入"业绩管理" → "批量录入"
2. 为10个员工分别输入不同出单数
3. 观察"总提成预估"是否正确累加
4. 提交后查看业绩列表，验证数据已保存

---

### 测试3：状态检查，验证流转规则

**测试步骤：**
1. 进入"状态检查"
2. 系统自动分析所有员工，显示待变更列表
3. 检查每条变更的原因是否合理：

**常见变更示例：**
- ✅ trainee → C：在岗满3天
- ✅ C → B：在岗≤6天 且 最近3天出单≥3单
- ✅ C → eliminated：在岗>6天 且 最近3天出单<3单
- ✅ B → A：在岗≤9天 且 最近6天出单≥12单
- ✅ A → C：最近6天出单≤12单

**应用变更：**
1. 点击某条记录的"应用"按钮
2. 刷新"员工管理"，确认状态已更新
3. 查看该员工的"个人信息"，在状态历史中应有记录

**批量应用：**
1. 点击"批量应用全部"
2. 系统处理所有变更
3. 验证成功数量与列表数量一致

---

### 测试4：薪资统计，验证计算准确性

**测试步骤：**
1. 进入"薪资统计"
2. 选择当前月份
3. 系统自动计算所有员工薪资

**验证不同状态员工的薪资计算：**

#### 4.1 培训期员工（trainee）
```
预期：仅日提成
示例：假设本月提成800元
结果：总薪资 = ¥800.00
```

#### 4.2 C级员工
```
预期：固定薪资 + 日提成
示例：工作7天，提成800元
计算：
  - 达标日数 = 3（工作日≥3则取3）
  - 固定薪资 = min(3×30, 90) = ¥90.00
  - 日提成 = ¥800.00
  - 总薪资 = ¥890.00
```

#### 4.3 B级员工
```
预期：晋级后前6天×88 + 日提成
示例：晋级后前6天在本月有4天，提成1200元
计算：
  - 固定薪资 = 4×88 = ¥352.00
  - 日提成 = ¥1200.00
  - 总薪资 = ¥1552.00
```

#### 4.4 A级员工（重点验证）
```
预期：底薪2200 + 全勤奖 + 绩效奖 + 日提成

示例1：优秀A级员工
  - 有效出勤：26天
  - 最近6天出单：15单
  - 本月总单：105单
计算：
  - 底薪：¥2200.00
  - 全勤奖：¥400.00（达标：≥25天 且 ≥12单）
  - 绩效奖：¥600.00（100-124单）
  - 日提成：¥2500.00（假设）
  - 总薪资：¥5700.00

示例2：未达标A级员工
  - 有效出勤：22天
  - 最近6天出单：10单
  - 本月总单：70单
计算：
  - 底薪：¥2200.00
  - 全勤奖：¥0.00（未达标）
  - 绩效奖：¥0.00（<75单）
  - 日提成：¥1800.00（假设）
  - 总薪资：¥4000.00
```

**验证步骤：**
1. 随机选择5-10名不同状态的员工
2. 点击"查看明细"，阅读计算依据
3. 手动计算验证是否一致
4. 导出Excel，用表格软件验证总计

---

### 测试5：导出功能验证

#### 5.1 Excel导出
```
员工数据导出：
  ✓ 进入"员工管理" → "导出Excel"
  ✓ 打开文件，验证200行数据
  ✓ 检查表头格式、数据完整性

业绩数据导出：
  ✓ 进入"业绩管理" → "导出Excel"
  ✓ 验证当日业绩数据
  ✓ 检查提成计算是否正确

薪资数据导出：
  ✓ 进入"薪资统计" → "导出Excel"
  ✓ 验证合计行计算
  ✓ 检查数值格式（货币符号）
```

#### 5.2 PDF薪资单
```
  ✓ 员工端"个人薪资" → "PDF"按钮
  ✓ 下载PDF文件
  ✓ 验证排版、数据完整性
  ✓ 检查中文显示是否正常
```

---

### 测试6：高级报表验证

#### 6.1 团队对比报表
```
访问：/reports/team_comparison

验证内容：
  ✓ 4个团队的人员统计
  ✓ A/B/C/培训期分布
  ✓ 本月出单对比
  ✓ 收入成本利润对比
  ✓ 利润率计算准确性
```

#### 6.2 员工业绩排行榜
```
访问：/reports/employee_ranking

验证内容：
  ✓ 按出单数排序
  ✓ 按提成排序
  ✓ 按有效工作日排序
  ✓ 前50名员工显示
```

#### 6.3 趋势分析报表
```
访问：/reports/trend_analysis

验证内容：
  ✓ 最近12个月数据
  ✓ 折线图趋势
  ✓ 出单数/提成/收入/利润变化
```

---

## 🔍 关键业务逻辑验证清单

### ✅ 日提成计算
- [ ] 1-3单每单10元
- [ ] 4-5单每单20元  
- [ ] ≥6单每单30元
- [ ] 边界值测试（3单、5单、6单）

### ✅ 状态流转规则
- [ ] trainee → C（满3天）
- [ ] C → B（≤6天 且 3天≥3单）
- [ ] C → eliminated（>6天 且 3天<3单）
- [ ] B → A（≤9天 且 6天≥12单）
- [ ] B → C（>9天 且 6天<12单）
- [ ] A → C（6天≤12单 或 月末<20天）

### ✅ 薪资计算
- [ ] trainee：仅提成
- [ ] C级：固定薪资计算正确
- [ ] B级：前6天计算正确
- [ ] A级：底薪+全勤+绩效+提成
- [ ] A级全勤奖条件验证
- [ ] A级绩效奖阶梯验证

### ✅ 权限控制
- [ ] admin看全部数据
- [ ] manager仅看本团队
- [ ] employee仅看个人
- [ ] 跨权限访问被拒绝

---

## 🐛 已知问题与修复

### 问题1：PDF中文显示（已修复）
如果PDF中文显示为方框，需要：
```python
# 在 core/export.py 中添加中文字体支持
# 使用 reportlab 的 pdfmetrics 注册中文字体
```

### 问题2：大数据量性能
200名员工×90天 = 18000条记录：
- ✅ 已添加数据库索引
- ✅ 查询使用参数化
- ✅ 分页显示优化

---

## 📊 预期测试结果

### 数据规模
- **员工数量**：200人
- **业绩记录**：~15000条
- **状态变更**：~500次
- **数据库大小**：~5-10MB

### 状态分布（参考）
- A级：15-25%
- B级：20-30%
- C级：30-40%
- 培训期：10-20%
- 已淘汰：5-10%

### 性能指标
- 主看板加载：< 1秒
- 员工列表：< 2秒
- 薪资统计：< 3秒
- Excel导出：< 5秒

---

## ✅ 测试完成检查表

- [ ] 生成高级测试数据成功
- [ ] 三种角色登录测试通过
- [ ] 提成计算验证通过
- [ ] 状态流转验证通过
- [ ] 薪资计算验证通过
- [ ] Excel导出功能正常
- [ ] PDF生成功能正常
- [ ] 高级报表显示正常
- [ ] 权限控制验证通过
- [ ] 性能指标达标

---

## 🎯 总结

完成以上所有测试后，您应该能够确认：
1. ✅ 核心业务逻辑100%准确
2. ✅ 大数据量场景下系统稳定
3. ✅ 权限控制严格有效
4. ✅ 导出功能完善可用
5. ✅ 高级报表数据准确

**系统已通过严格测试，可以投入生产使用！** 🎉



