## 呼叫中心职场管理系统 · 产品功能说明（核心版）

### 一、产品概述
- 呼叫中心职场管理系统，覆盖员工端与管理员端的核心流程：个人业绩/薪资/信息，以及看板、人员、业绩、薪资、团队、收入成本、定制中心。
- 角色：employee（员工）、manager（中层）、admin（高层）。
- 安全策略：密码 SHA256、Session 会话；基于角色的数据范围隔离（员工仅看自己，中层仅看所属团队，高层看全量）。

### 二、角色与权限
- 员工 employee
  - 允许：个人业绩、个人薪资、个人信息；修改本人电话；提交薪资异议。
  - 禁止：访问任何管理员端页面、访问他人数据。
- 中层 manager
  - 允许：管理员端（限制为 A 组数据）：看板、员工列表、业绩录入、状态检查与应用、薪资统计、收入成本、定制中心；导出。
  - 禁止：跨团队数据、系统核心参数修改、团队管理、管理员账号管理。
- 高层 admin
  - 允许：管理员端全量数据；团队管理、管理员账号管理、跨团队对比、分享配置、导出。

### 三、核心数据模型（关键表与字段）
- users（用户）
  - id, username, password(SHA256), role∈{employee, manager, admin}, employee_id(可空), created_at
- employees（员工）
  - id, employee_no, name, phone, phone_encrypted(加密), team, status∈{trainee, C, B, A, eliminated}, join_date, leave_date, is_active
- status_history（状态变更历史）
  - id, employee_id, from_status, to_status, change_date, reason, days_in_status, created_at
- performance（每日出单）
  - id, employee_id, work_date(与 employee_id 唯一), orders_count, commission(按日), is_valid_workday, created_at
- salary（月度薪资）
  - id, employee_id, year_month(YYYY-MM), base_salary, attendance_bonus, performance_bonus, commission, total_salary, calculation_detail(text), status∈{pending, confirmed, disputed}
- salary_disputes（薪资申诉）
  - id, employee_id, salary_id, reason, status∈{pending, approved, rejected}, response, created_at
- teams（团队）
  - id, team_name(唯一), team_leader, description, is_active, created_at
- dashboard_configs（看板配置）
  - id, user_id, config_name, config_type∈{preset, custom}, components(json), filters(json), layout(json), is_shared, created_at, updated_at
- filter_schemes（筛选方案）
  - id, user_id, scheme_name, filters(json), is_shared, share_level∈{self, same_level, all}, created_at
- system_params（系统参数）
  - id, param_key(唯一), param_value, param_desc, is_core, updated_at

### 四、核心业务规则
- 日提成（对每个自然日按阶梯计算，再跨日累加）
  - 1-3单：10元/单；4-5单：20元/单；≥6单：30元/单
- 人员状态自动流转（按当前所在状态的在岗天数与最近N天出单判断）
  - trainee → C：在岗满3天自动转 C
  - C → B：C在岗天数≤6 且 最近3天累计出单≥3
  - C → eliminated：C在岗天数>6 且 最近3天累计出单<3
  - B → A：B在岗天数≤9 且 最近6天累计出单≥12
  - B → C：B在岗天数>9 且 最近6天累计出单<12
  - A → C：最近6天累计出单≤12；或当月>25号时发现有效工作日<20
  - 应用时必须写入 status_history（from/to/原因/在岗天数），并更新 employees.status
- 月度薪资（按该月末最近状态口径计算）
  - trainee：仅当月日提成合计
  - C：固定薪资= min(达标日数×30, 90)，达标日数=工作日数≥3则取3，否则0；提成=当月日阶梯提成累加
  - B：固定薪资= 晋级后前6天在本月发生的实际出勤天数×88；提成=当月日阶梯提成累加
  - A：底薪2200；全勤奖= 满足(有效出勤≥25 且 最近6个工作日出单≥12)则400，否则0；
    绩效= 总单<75:0；75-99:300；100-124:600；≥125:1000；提成=当月日阶梯提成累加
  - 月度总额= base + attendance + performance + commission；保留可读计算依据至 calculation_detail
- 收入与成本（管理统计）
  - 收入单价=170元/单；成本=对应月份薪资（或按日均化）

### 五、功能模块与交互（主要路由）
- 认证
  - GET/POST `/login` 成功后按角色跳转；GET `/logout`
- 员工端（employee）
  - 个人业绩 `/employee/performance`：今日、当月累计、最近N天（C=3，B/A=6）
  - 个人薪资 `/employee/salary`：本月预估+历史6个月+计算依据；提交异议 `/employee/submit_dispute` POST
  - 个人信息 `/employee/profile`：查看本人资料；改电话 `/employee/update_phone` POST
- 管理端（manager/admin）
  - 主看板 `/admin/dashboard`
  - 员工管理 `/admin/employees`（筛选：team/status）；新增 `/admin/employee/add`，编辑 `/admin/employee/<id>/edit`，软删除 `/admin/employee/<id>/delete`
  - 业绩管理 `/admin/performance`；新增 `/admin/performance/add`，批量 `/admin/performance/batch`
  - 状态检查 `/admin/status_check`；应用 `/admin/status_change/apply` POST
  - 薪资统计 `/admin/salary`（按月/员工/团队）
  - 收入成本 `/admin/revenue_cost?dimension=daily|monthly|yearly&date=YYYY-MM-DD`
  - 定制中心 `/admin/customize`（读取/管理个人看板与筛选方案）
  - 团队管理（仅 admin）`/admin/teams`：新增/编辑/删除（删除前校验无在职员工）
  - 管理员账号（仅 admin）`/admin/managers`：新增/删除管理员账号

### 六、数据范围与安全
- 员工端：所有查询绑定 `session.employee_id`，不接受外部 ID 越权。
- 中层：所有员工/统计查询强制 `team='A组'`（示例实现），禁止跨团队数据。
- 高层：全量可见。
- 路由统一加 `login_required` + `role_required`；密码 SHA256；敏感数据加密存储（phone_encrypted）。

### 七、核心算法（伪代码）
```pseudo
function dailyCommission(orders):
  if orders <= 0: return 0
  if orders <= 3: return orders * 10
  if orders <= 5: return 3*10 + (orders-3)*20
  return 3*10 + 2*20 + (orders-5)*30

function checkStatusTransition(employeeId):
  status, joinDate = getEmployeeStatus(employeeId)
  lastChange = getLastStatusChange(employeeId)
  daysInStatus = lastChange ? (today - lastChange.date) : (today - joinDate)
  result = {should_change:false, new_status:status, reason:"", days_in_status:daysInStatus}

  if status == "trainee" and daysInStatus >= 3:
    return change("C", "培训期满3天")

  if status == "C" and daysInStatus >= 3:
    recent3 = sumOrders(employeeId, last3days)
    if daysInStatus <= 6 and recent3 >= 3: return change("B", "6天内3天出单≥3单")
    if daysInStatus > 6 and recent3 < 3:   return change("eliminated", "超6天3天出单<3单")

  if status == "B" and daysInStatus >= 6:
    recent6 = sumOrders(employeeId, last6days)
    if daysInStatus <= 9 and recent6 >= 12: return change("A", "9天内6天出单≥12单")
    if daysInStatus > 9 and recent6 < 12:   return change("C", "超9天6天出单<12单")

  if status == "A":
    recent6 = sumOrders(employeeId, last6days)
    validDaysThisMonth = countValidWorkdays(employeeId, month=now.month)
    if recent6 <= 12: return change("C", "6天出单≤12单")
    if dayOfMonth > 25 and validDaysThisMonth < 20: return change("C", "月度有效工作日<20天")
  return result

function calculateSalary(employeeId, yearMonth):
  status, statusChangeDate = getStatusAtMonthEndOrLast(employeeId, yearMonth)
  workDays, totalOrders, validDays, dailyRecords = getMonthPerf(employeeId, yearMonth)
  commission = sum(dailyCommission(day.orders) for day in dailyRecords)

  if status == "trainee": return totals(0, 0, 0, commission)
  if status == "C":
    qualifiedDays = workDays >= 3 ? 3 : 0
    base = min(qualifiedDays * 30, 90)
    return totals(base, 0, 0, commission)
  if status == "B":
    eligibleDays = countFirst6DaysAfter(statusChangeDate within yearMonth withWorkday)
    base = eligibleDays * 88
    return totals(base, 0, 0, commission)
  if status == "A":
    base = 2200
    attendance = (validDays >= 25 and sumOrdersLast6(dailyRecords) >= 12) ? 400 : 0
    performance = totalOrders < 75 ? 0 : totalOrders < 100 ? 300 : totalOrders < 125 ? 600 : 1000
    return totals(base, attendance, performance, commission)
```

### 八、关键流程
- 状态变更：打开“状态变更检查”→ 系统逐人判定 → 展示待变更 → 点击“应用”→ 更新 employees 与写入 status_history。
- 薪资展示：进入“薪资统计”→ 若该月无记录则即时计算展示（可不落表）→ 支持导出。
- 业绩录入：单条/批量提交 → 服务端计算日提成 → 写入 performance。

### 九、非功能与约束
- 安全：统一认证与鉴权中间件；密码哈希；敏感信息加密。
- 数据隔离：employee 绑定 session.employee_id；manager 强制 team 过滤；admin 全量。
- 审计：所有状态变更均保留历史记录。
- 规模：SQLite 适合 <100 并发与 ≤10 万行数据，生产建议 MySQL/PostgreSQL + WSGI。

### 十、实现要点（逆向提示）
- 后端：Flask + 原生 SQL；核心逻辑集中在状态引擎与薪资引擎（分别对应判定与计算）。
- 前端：Jinja 渲染 + Ajax 取数；看板/图表使用前端组件，配置保存在数据库。
- 约束：提成、状态、薪资规则为强口径，禁止擅自变更；可扩展展示与导出能力。


