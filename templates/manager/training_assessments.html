{% extends "base.html" %}

{% block title %}åŸ¹è®­è€ƒæ ¸ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“š åŸ¹è®­è€ƒæ ¸ç®¡ç†</h1>
    <p style="color: var(--gray-600); margin-top: var(--space-8);">å½•å…¥å‘˜å·¥åŸ¹è®­è€ƒæ ¸ç»“æœ</p>
</div>

<!-- åŸ¹è®­æœŸå‘˜å·¥åˆ—è¡¨ -->
<div class="card" style="margin-bottom: var(--space-24);">
    <div class="card-header">
        <h2>åŸ¹è®­æœŸå‘˜å·¥</h2>
    </div>
    <div class="card-body">
        {% if trainees %}
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>å…¥èŒæ—¥æœŸ</th>
                    <th>åœ¨èŒå¤©æ•°</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in trainees %}
                <tr>
                    <td>{{ employee.employee_no }}</td>
                    <td>{{ employee.name }}</td>
                    <td><span class="badge badge-info">{{ employee.team }}</span></td>
                    <td>{{ employee.join_date }}</td>
                    <td>{{ (now.date() - employee.join_date|default(now.date()))|abs if employee.join_date else 0 }}å¤©</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openAssessmentModal({{ employee.id }}, '{{ employee.employee_no }}', '{{ employee.name }}')">
                            å½•å…¥è€ƒæ ¸
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— åŸ¹è®­æœŸå‘˜å·¥</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- è€ƒæ ¸è®°å½• -->
<div class="card">
    <div class="card-header">
        <h2>è€ƒæ ¸è®°å½•</h2>
    </div>
    <div class="card-body">
        {% if assessments %}
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>è€ƒæ ¸æ—¥æœŸ</th>
                    <th>è¯æœ¯æµ‹è¯•</th>
                    <th>æ¨¡æ‹Ÿå‡ºå•</th>
                    <th>ç»¼åˆç»“æœ</th>
                    <th>å½•å…¥äºº</th>
                    <th>å¤‡æ³¨</th>
                </tr>
            </thead>
            <tbody>
                {% for assessment in assessments %}
                <tr>
                    <td>{{ assessment.employee_no }}</td>
                    <td>{{ assessment.employee_name }}</td>
                    <td><span class="badge badge-info">{{ assessment.team }}</span></td>
                    <td>{{ assessment.assessment_date }}</td>
                    <td>
                        {% if assessment.script_test_result == 'passed' %}
                        <span class="badge badge-success">âœ“ é€šè¿‡</span>
                        {% else %}
                        <span class="badge badge-danger">âœ— æœªé€šè¿‡</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if assessment.mock_order_result == 'passed' %}
                        <span class="badge badge-success">âœ“ é€šè¿‡</span>
                        {% else %}
                        <span class="badge badge-danger">âœ— æœªé€šè¿‡</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if assessment.both_passed == 1 %}
                        <span class="badge badge-success">âœ“ å…¨éƒ¨é€šè¿‡</span>
                        {% else %}
                        <span class="badge badge-warning">éƒ¨åˆ†é€šè¿‡</span>
                        {% endif %}
                    </td>
                    <td>{{ assessment.recorder_name }}</td>
                    <td>{{ assessment.notes or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— è€ƒæ ¸è®°å½•</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- è€ƒæ ¸å½•å…¥å¼¹çª— -->
<div id="assessmentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>å½•å…¥åŸ¹è®­è€ƒæ ¸ç»“æœ</h3>
            <button class="modal-close" onclick="closeAssessmentModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('manager.record_assessment') }}">
            <div class="modal-body">
                <input type="hidden" name="employee_id" id="employee_id">
                
                <div class="form-group">
                    <label class="form-label">å‘˜å·¥</label>
                    <input type="text" id="employee_info" class="form-input" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">åŸºç¡€è¯æœ¯æµ‹è¯• <span style="color: var(--color-danger);">*</span></label>
                    <select name="script_result" class="form-select" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="passed">âœ“ é€šè¿‡</option>
                        <option value="failed">âœ— æœªé€šè¿‡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ¨¡æ‹Ÿå‡ºå•æµ‹è¯• <span style="color: var(--color-danger);">*</span></label>
                    <select name="mock_result" class="form-select" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="passed">âœ“ é€šè¿‡</option>
                        <option value="failed">âœ— æœªé€šè¿‡</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å¤‡æ³¨</label>
                    <textarea name="notes" class="form-input" rows="3" placeholder="å¯é€‰å¡«å†™è€ƒæ ¸å¤‡æ³¨"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAssessmentModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-primary">æäº¤è€ƒæ ¸</button>
            </div>
        </form>
    </div>
</div>

<script>
function openAssessmentModal(employeeId, employeeNo, employeeName) {
    document.getElementById('employee_id').value = employeeId;
    document.getElementById('employee_info').value = `${employeeNo} - ${employeeName}`;
    document.getElementById('assessmentModal').style.display = 'flex';
}

function closeAssessmentModal() {
    document.getElementById('assessmentModal').style.display = 'none';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('assessmentModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAssessmentModal();
    }
});
</script>
{% endblock %}



