{% extends "base.html" %}

{% block title %}æ™‹çº§å®¡æ‰¹ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ğŸ“ˆ æ™‹çº§å®¡æ‰¹ç®¡ç†</h1>
    <p style="color: var(--gray-600); margin-top: var(--space-8);">å®¡æ‰¹å‘˜å·¥æ™‹çº§ç”³è¯·</p>
</div>

<!-- å¾…å®¡æ‰¹ -->
<div class="card" style="margin-bottom: var(--space-24);">
    <div class="card-header">
        <h2>å¾…å®¡æ‰¹æ™‹çº§ç”³è¯·</h2>
        <span class="badge badge-warning">{{ pending_promotions|length }}æ¡</span>
    </div>
    <div class="card-body">
        {% if pending_promotions %}
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>æ™‹çº§è·¯å¾„</th>
                    <th>è§¦å‘æ—¥æœŸ</th>
                    <th>è§¦å‘åŸå› </th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for promotion in pending_promotions %}
                <tr>
                    <td>{{ promotion.employee_no }}</td>
                    <td>{{ promotion.employee_name }}</td>
                    <td><span class="badge badge-info">{{ promotion.team }}</span></td>
                    <td>
                        <span class="badge" style="background: var(--gray-400);">{{ promotion.from_status }}</span>
                        â†’
                        <span class="badge badge-success">{{ promotion.to_status }}</span>
                    </td>
                    <td>{{ promotion.trigger_date }}</td>
                    <td style="max-width: 300px;">{{ promotion.trigger_reason }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('manager.approve_promotion_action', promotion_id=promotion.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('ç¡®è®¤æ‰¹å‡†æ™‹çº§å—ï¼Ÿ')">
                                âœ“ æ‰¹å‡†
                            </button>
                        </form>
                        <button class="btn btn-sm btn-danger" onclick="openRejectModal({{ promotion.id }}, '{{ promotion.employee_name }}', '{{ promotion.from_status }}â†’{{ promotion.to_status }}')">
                            âœ— é©³å›
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>âœ“ æš‚æ— å¾…å®¡æ‰¹æ™‹çº§ç”³è¯·</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- å†å²è®°å½• -->
<div class="card">
    <div class="card-header">
        <h2>å®¡æ‰¹å†å²</h2>
    </div>
    <div class="card-body">
        {% if history_promotions %}
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>æ™‹çº§è·¯å¾„</th>
                    <th>çŠ¶æ€</th>
                    <th>å®¡æ‰¹äºº</th>
                    <th>å®¡æ‰¹æ—¶é—´</th>
                    <th>ç”Ÿæ•ˆæ—¥æœŸ</th>
                </tr>
            </thead>
            <tbody>
                {% for promotion in history_promotions %}
                <tr>
                    <td>{{ promotion.employee_no }}</td>
                    <td>{{ promotion.employee_name }}</td>
                    <td>{{ promotion.from_status }} â†’ {{ promotion.to_status }}</td>
                    <td>
                        {% if promotion.status == 'approved' %}
                        <span class="badge badge-success">å·²æ‰¹å‡†</span>
                        {% elif promotion.status == 'rejected' %}
                        <span class="badge badge-danger">å·²é©³å›</span>
                        {% elif promotion.status == 'overridden' %}
                        <span class="badge badge-warning">å·²å¦å†³</span>
                        {% endif %}
                    </td>
                    <td>{{ promotion.approver_name or '-' }}</td>
                    <td>{{ promotion.approved_at or '-' }}</td>
                    <td>{{ promotion.effective_date or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>æš‚æ— å®¡æ‰¹å†å²</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- é©³å›åŸå› å¼¹çª— -->
<div id="rejectModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>é©³å›æ™‹çº§ç”³è¯·</h3>
            <button class="modal-close" onclick="closeRejectModal()">&times;</button>
        </div>
        <form method="POST" id="rejectForm">
            <div class="modal-body">
                <p id="rejectInfo" style="color: var(--gray-700); margin-bottom: var(--space-16);"></p>
                
                <div class="form-group">
                    <label class="form-label">é©³å›åŸå›  <span style="color: var(--color-danger);">*</span></label>
                    <textarea name="reason" class="form-input" rows="4" required placeholder="è¯·è¯¦ç»†è¯´æ˜é©³å›åŸå› ..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeRejectModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn btn-danger">ç¡®è®¤é©³å›</button>
            </div>
        </form>
    </div>
</div>

<script>
function openRejectModal(promotionId, employeeName, promotionPath) {
    document.getElementById('rejectInfo').textContent = `å‘˜å·¥ï¼š${employeeName} | æ™‹çº§ï¼š${promotionPath}`;
    document.getElementById('rejectForm').action = `/manager/promotions/${promotionId}/reject`;
    document.getElementById('rejectModal').style.display = 'flex';
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
}

document.getElementById('rejectModal').addEventListener('click', function(e) {
    if (e.target === this) closeRejectModal();
});
</script>
{% endblock %}



