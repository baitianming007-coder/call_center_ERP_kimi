{% extends "base.html" %}

{% block title %}æ‰¹é‡å½•å…¥ä¸šç»© - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="mb-24">
    <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900);">
        ğŸ“ æ‰¹é‡å½•å…¥ä¸šç»©
    </h1>
    <p style="color: var(--gray-600); margin-top: var(--space-8);">
        ä¸ºå¤šåå‘˜å·¥åŒæ—¶å½•å…¥æŒ‡å®šæ—¥æœŸçš„ä¸šç»©æ•°æ®
    </p>
</div>

<!-- æ—¥æœŸé€‰æ‹© -->
<div class="card mb-24">
    <div class="card-body">
        <div class="form-group" style="max-width: 300px; margin: 0;">
            <label class="form-label required">å½•å…¥æ—¥æœŸ</label>
            <input type="date" id="batchDate" class="form-input" value="{{ default_date }}">
        </div>
    </div>
</div>

<!-- æ‰¹é‡å½•å…¥è¡¨æ ¼ -->
<div class="card">
    <div class="card-header">
        <h3>å‘˜å·¥ä¸šç»©å½•å…¥</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>å·¥å·</th>
                        <th>å§“å</th>
                        <th>çŠ¶æ€</th>
                        <th>å‡ºå•æ•°</th>
                        <th>é¢„è®¡ææˆ</th>
                        <th>æœ‰æ•ˆå·¥ä½œæ—¥</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td><strong>{{ emp.employee_no }}</strong></td>
                        <td>{{ emp.name }}</td>
                        <td>
                            <span class="badge badge-{{ emp.status }}">{{ emp.status | status_label }}</span>
                        </td>
                        <td>
                            <input 
                                type="number" 
                                class="form-input orders-input" 
                                style="width: 100px;"
                                min="0" 
                                value="0"
                                data-employee-id="{{ emp.id }}"
                                onchange="calculateBatchCommission(this)"
                            >
                        </td>
                        <td>
                            <span class="commission-display" data-employee-id="{{ emp.id }}" style="color: var(--color-success); font-weight: 600;">
                                Â¥0.00
                            </span>
                        </td>
                        <td>
                            <input 
                                type="checkbox" 
                                class="valid-checkbox" 
                                data-employee-id="{{ emp.id }}"
                                checked
                                style="width: 18px; height: 18px; cursor: pointer;"
                            >
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: var(--space-24); display: flex; justify-content: space-between; align-items: center;">
            <div style="color: var(--gray-600);">
                æ€»ææˆé¢„ä¼°ï¼š<strong id="totalCommission" style="color: var(--color-success); font-size: 18px;">Â¥0.00</strong>
            </div>
            <div style="display: flex; gap: var(--space-12);">
                <a href="{{ url_for('admin.performance') }}" class="btn btn-secondary">å–æ¶ˆ</a>
                <button class="btn btn-primary" onclick="submitBatch()">æäº¤æ‰¹é‡å½•å…¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function calculateCommission(orders) {
        if (orders <= 3) return orders * 10;
        if (orders <= 5) return 3 * 10 + (orders - 3) * 20;
        return 3 * 10 + 2 * 20 + (orders - 5) * 30;
    }
    
    function calculateBatchCommission(input) {
        const orders = parseInt(input.value) || 0;
        const empId = input.dataset.employeeId;
        const commission = calculateCommission(orders);
        
        const display = document.querySelector(`.commission-display[data-employee-id="${empId}"]`);
        display.textContent = 'Â¥' + commission.toFixed(2);
        
        updateTotalCommission();
    }
    
    function updateTotalCommission() {
        let total = 0;
        document.querySelectorAll('.orders-input').forEach(input => {
            const orders = parseInt(input.value) || 0;
            total += calculateCommission(orders);
        });
        document.getElementById('totalCommission').textContent = 'Â¥' + total.toFixed(2);
    }
    
    function submitBatch() {
        const date = document.getElementById('batchDate').value;
        if (!date) {
            showToast('è¯·é€‰æ‹©å½•å…¥æ—¥æœŸ', 'warning');
            return;
        }
        
        const batchData = [];
        document.querySelectorAll('.orders-input').forEach(input => {
            const orders = parseInt(input.value) || 0;
            if (orders > 0) {
                const empId = input.dataset.employeeId;
                const isValid = document.querySelector(`.valid-checkbox[data-employee-id="${empId}"]`).checked ? 1 : 0;
                batchData.push({
                    employee_id: empId,
                    orders_count: orders,
                    is_valid_workday: isValid
                });
            }
        });
        
        if (batchData.length === 0) {
            showToast('è¯·è‡³å°‘å½•å…¥ä¸€æ¡æ•°æ®', 'warning');
            return;
        }
        
        if (!confirmAction(`ç¡®å®šè¦ä¸º ${batchData.length} åå‘˜å·¥æ‰¹é‡å½•å…¥ä¸šç»©å—ï¼Ÿ`)) {
            return;
        }
        
        fetch('{{ url_for("admin.performance_batch") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(batchData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("admin.performance") }}?date=' + date;
                }, 1500);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æäº¤å¤±è´¥ï¼š' + error, 'danger');
        });
    }
</script>
{% endblock %}



