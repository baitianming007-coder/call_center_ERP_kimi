{% extends "base.html" %}

{% block title %}çŠ¶æ€æ£€æŸ¥ - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="mb-24">
    <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
        ğŸ”„ çŠ¶æ€å˜æ›´æ£€æŸ¥
    </h1>
    <p style="color: var(--gray-600);">ç³»ç»Ÿæ£€æµ‹åˆ° {{ changes|length }} åå‘˜å·¥éœ€è¦å˜æ›´çŠ¶æ€</p>
</div>

<!-- å¾…å˜æ›´åˆ—è¡¨ -->
{% if changes %}
<div class="card">
    <div class="card-header flex-between">
        <h3>å¾…å˜æ›´å‘˜å·¥åˆ—è¡¨</h3>
        <button class="btn btn-success" onclick="applyAllChanges()">æ‰¹é‡åº”ç”¨å…¨éƒ¨</button>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>å½“å‰çŠ¶æ€</th>
                    <th>â†’</th>
                    <th>æ–°çŠ¶æ€</th>
                    <th>å˜æ›´åŸå› </th>
                    <th>åœ¨å²—å¤©æ•°</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for change in changes %}
                <tr id="change-row-{{ change.employee_id }}">
                    <td><strong>{{ change.employee_no }}</strong></td>
                    <td>{{ change.name }}</td>
                    <td>{{ change.team }}</td>
                    <td>
                        <span class="badge badge-{{ change.old_status }}">{{ change.old_status | status_label }}</span>
                    </td>
                    <td style="text-align: center; font-size: 18px;">â†’</td>
                    <td>
                        <span class="badge badge-{{ change.new_status }}">{{ change.new_status | status_label }}</span>
                    </td>
                    <td style="color: var(--gray-700);">{{ change.reason }}</td>
                    <td>{{ change.days_in_status }} å¤©</td>
                    <td class="actions">
                        <button 
                            class="btn btn-sm btn-primary" 
                            onclick="applyChange({{ change.employee_id }}, '{{ change.new_status }}', '{{ change.reason }}', {{ change.days_in_status }}, '{{ change.name }}')"
                        >
                            åº”ç”¨
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- çŠ¶æ€æµè½¬è§„åˆ™è¯´æ˜ -->
<div class="card mt-24">
    <div class="card-header">
        <h3>ğŸ“‹ çŠ¶æ€æµè½¬è§„åˆ™</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-24);">
            <div>
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--space-12); color: var(--gray-800);">æ™‹å‡è§„åˆ™</h4>
                <ul style="list-style: none; padding: 0; margin: 0; color: var(--gray-700); font-size: 14px; line-height: 1.8;">
                    <li>â€¢ åŸ¹è®­æœŸ â†’ Cçº§ï¼šåœ¨å²—æ»¡ <strong>3å¤©</strong></li>
                    <li>â€¢ Cçº§ â†’ Bçº§ï¼šåœ¨å²—â‰¤6å¤© ä¸” æœ€è¿‘3å¤©å‡ºå•â‰¥<strong>3å•</strong></li>
                    <li>â€¢ Bçº§ â†’ Açº§ï¼šåœ¨å²—â‰¤9å¤© ä¸” æœ€è¿‘6å¤©å‡ºå•â‰¥<strong>12å•</strong></li>
                </ul>
            </div>
            
            <div>
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: var(--space-12); color: var(--gray-800);">é™çº§/æ·˜æ±°è§„åˆ™</h4>
                <ul style="list-style: none; padding: 0; margin: 0; color: var(--gray-700); font-size: 14px; line-height: 1.8;">
                    <li>â€¢ Cçº§ â†’ æ·˜æ±°ï¼šåœ¨å²—>6å¤© ä¸” æœ€è¿‘3å¤©å‡ºå•<strong><3å•</strong></li>
                    <li>â€¢ Bçº§ â†’ Cçº§ï¼šåœ¨å²—>9å¤© ä¸” æœ€è¿‘6å¤©å‡ºå•<strong><12å•</strong></li>
                    <li>â€¢ Açº§ â†’ Cçº§ï¼šæœ€è¿‘6å¤©å‡ºå•â‰¤12 æˆ– æœˆæœ«æœ‰æ•ˆå·¥ä½œæ—¥<20</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- æ— å¾…å˜æ›´ -->
<div class="card">
    <div class="card-body" style="text-align: center; padding: var(--space-48);">
        <div style="font-size: 64px; margin-bottom: var(--space-16);">âœ…</div>
        <h3 style="font-size: 20px; font-weight: 600; color: var(--gray-900); margin-bottom: var(--space-8);">
            æ‰€æœ‰å‘˜å·¥çŠ¶æ€æ­£å¸¸
        </h3>
        <p style="color: var(--gray-600);">
            å½“å‰æ²¡æœ‰éœ€è¦å˜æ›´çŠ¶æ€çš„å‘˜å·¥
        </p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    function applyChange(employeeId, newStatus, reason, daysInStatus, name) {
        if (!confirmAction(`ç¡®å®šè¦å°†å‘˜å·¥"${name}"çš„çŠ¶æ€å˜æ›´ä¸º"${newStatus}"å—ï¼Ÿ`)) {
            return;
        }
        
        fetch('{{ url_for("admin.status_change_apply") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                employee_id: employeeId,
                new_status: newStatus,
                reason: reason,
                days_in_status: daysInStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // ç§»é™¤è¯¥è¡Œ
                const row = document.getElementById(`change-row-${employeeId}`);
                if (row) {
                    row.style.transition = 'opacity 0.3s';
                    row.style.opacity = '0';
                    setTimeout(() => row.remove(), 300);
                }
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥ï¼š' + error, 'danger');
        });
    }
    
    function applyAllChanges() {
        if (!confirmAction(`ç¡®å®šè¦æ‰¹é‡åº”ç”¨å…¨éƒ¨ {{ changes|length }} æ¡çŠ¶æ€å˜æ›´å—ï¼Ÿ`)) {
            return;
        }
        
        const changes = {{ changes | tojson }};
        let successCount = 0;
        let failCount = 0;
        
        // ä¾æ¬¡å¤„ç†æ¯ä¸ªå˜æ›´
        Promise.all(changes.map(change => {
            return fetch('{{ url_for("admin.status_change_apply") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    employee_id: change.employee_id,
                    new_status: change.new_status,
                    reason: change.reason,
                    days_in_status: change.days_in_status
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    successCount++;
                } else {
                    failCount++;
                }
            });
        }))
        .then(() => {
            showToast(`æ‰¹é‡åº”ç”¨å®Œæˆï¼šæˆåŠŸ ${successCount} æ¡ï¼Œå¤±è´¥ ${failCount} æ¡`, 'success');
            setTimeout(() => location.reload(), 1500);
        })
        .catch(error => {
            showToast('æ‰¹é‡æ“ä½œå¤±è´¥ï¼š' + error, 'danger');
        });
    }
</script>
{% endblock %}



