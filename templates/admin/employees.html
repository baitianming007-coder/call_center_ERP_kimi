{% extends "base.html" %}

{% block title %}å‘˜å·¥ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="flex-between mb-24">
    <div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
            ğŸ‘¥ å‘˜å·¥ç®¡ç†
        </h1>
        <p style="color: var(--gray-600);">å…± {{ employees|length }} åå‘˜å·¥</p>
    </div>
    <div style="display: flex; gap: var(--space-12);">
        <a href="{{ url_for('export.export_employees_excel') }}" class="btn btn-success">ğŸ“¥ å¯¼å‡ºExcel</a>
        <a href="{{ url_for('admin.employee_add') }}" class="btn btn-primary">+ æ·»åŠ å‘˜å·¥</a>
    </div>
</div>

<!-- ç­›é€‰æ  -->
<div class="card mb-24">
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.employees') }}" id="filterForm">
            <!-- åŸºç¡€ç­›é€‰ -->
            <div style="display: flex; gap: var(--space-16); align-items: flex-end; margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">æœç´¢</label>
                    <input type="text" name="search" class="form-input" placeholder="å§“åæˆ–å·¥å·" value="{{ search_keyword }}">
                </div>
                
                {% if user.role == 'admin' %}
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">å›¢é˜Ÿ</label>
                    <select name="team" class="form-select">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        {% for t in teams %}
                        <option value="{{ t.team }}" {% if current_team == t.team %}selected{% endif %}>{{ t.team }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">çŠ¶æ€</label>
                    <select name="status" class="form-select">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="A" {% if current_status == 'A' %}selected{% endif %}>Açº§</option>
                        <option value="B" {% if current_status == 'B' %}selected{% endif %}>Bçº§</option>
                        <option value="C" {% if current_status == 'C' %}selected{% endif %}>Cçº§</option>
                        <option value="trainee" {% if current_status == 'trainee' %}selected{% endif %}>åŸ¹è®­æœŸ</option>
                        <option value="eliminated" {% if current_status == 'eliminated' %}selected{% endif %}>å·²æ·˜æ±°</option>
                    </select>
                </div>
                
                <button type="button" onclick="toggleAdvancedFilters()" class="btn btn-secondary">
                    <span id="advancedToggleIcon">â–¼</span> é«˜çº§ç­›é€‰
                </button>
                <button type="submit" class="btn btn-primary">ğŸ” æŸ¥è¯¢</button>
                <a href="{{ url_for('admin.employees') }}" class="btn btn-secondary">ğŸ”„ é‡ç½®</a>
            </div>
            
            <!-- é«˜çº§ç­›é€‰ï¼ˆå¯æŠ˜å ï¼‰ -->
            <div id="advancedFilters" style="display: none; padding-top: var(--space-16); border-top: 1px solid var(--gray-200);">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-16);">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">å…¥èŒæ—¥æœŸèŒƒå›´</label>
                        <div style="display: flex; gap: var(--space-8); align-items: center;">
                            <input type="date" name="join_date_from" class="form-input" value="{{ request.args.get('join_date_from', '') }}">
                            <span style="color: var(--gray-500);">è‡³</span>
                            <input type="date" name="join_date_to" class="form-input" value="{{ request.args.get('join_date_to', '') }}">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">æœ¬æœˆå‡ºå•èŒƒå›´</label>
                        <div style="display: flex; gap: var(--space-8); align-items: center;">
                            <input type="number" name="orders_from" class="form-input" placeholder="æœ€å°‘" min="0" value="{{ request.args.get('orders_from', '') }}">
                            <span style="color: var(--gray-500);">è‡³</span>
                            <input type="number" name="orders_to" class="form-input" placeholder="æœ€å¤š" min="0" value="{{ request.args.get('orders_to', '') }}">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">åœ¨èŒå¤©æ•°èŒƒå›´</label>
                        <div style="display: flex; gap: var(--space-8); align-items: center;">
                            <input type="number" name="work_days_from" class="form-input" placeholder="æœ€å°‘" min="0" value="{{ request.args.get('work_days_from', '') }}">
                            <span style="color: var(--gray-500);">è‡³</span>
                            <input type="number" name="work_days_to" class="form-input" placeholder="æœ€å¤š" min="0" value="{{ request.args.get('work_days_to', '') }}">
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- æ‰¹é‡æ“ä½œæ  -->
<div id="batchActionsBar" style="display: none; background: var(--color-info); color: white; padding: var(--space-16); border-radius: var(--radius-md); margin-bottom: var(--space-16);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span style="font-weight: 600;">å·²é€‰æ‹© <span id="selectedCount">0</span> åå‘˜å·¥</span>
        </div>
        <div style="display: flex; gap: var(--space-12);">
            <button onclick="batchExport()" class="btn btn-light">ğŸ“¥ æ‰¹é‡å¯¼å‡º</button>
            {% if user.role == 'admin' %}
            <button onclick="batchChangeTeam()" class="btn btn-light">ğŸ‘¥ æ‰¹é‡ä¿®æ”¹å›¢é˜Ÿ</button>
            {% endif %}
            <button onclick="clearSelection()" class="btn btn-secondary">âœ• å–æ¶ˆé€‰æ‹©</button>
        </div>
    </div>
</div>

<!-- å‘˜å·¥åˆ—è¡¨ -->
<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>çŠ¶æ€</th>
                    <th>æ‰‹æœºå·</th>
                    <th>å…¥èŒæ—¥æœŸ</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% if employees %}
                    {% for emp in employees %}
                    <tr>
                        <td>
                            <input type="checkbox" class="emp-checkbox" value="{{ emp.id }}" 
                                   data-name="{{ emp.name }}" data-no="{{ emp.employee_no }}"
                                   onchange="updateSelection()">
                        </td>
                        <td><strong>{{ emp.employee_no }}</strong></td>
                        <td>{{ emp.name }}</td>
                        <td>{{ emp.team }}</td>
                        <td>
                            <span class="badge badge-{{ emp.status }}">{{ emp.status | status_label }}</span>
                        </td>
                        <td>{{ emp.phone or '-' }}</td>
                        <td>{{ emp.join_date }}</td>
                        <td class="actions">
                            <a href="{{ url_for('admin.employee_edit', emp_id=emp.id) }}" class="btn btn-sm btn-secondary">ç¼–è¾‘</a>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmployee({{ emp.id }}, '{{ emp.name }}')">åˆ é™¤</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: var(--space-48); color: var(--gray-500);">
                            æš‚æ— å‘˜å·¥æ•°æ®
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- åˆ†é¡µæ§ä»¶ -->
    {% if pagination and pagination.total_pages > 1 %}
    <div style="margin-top: var(--space-24); display: flex; justify-content: space-between; align-items: center;">
        <div style="color: var(--gray-600); font-size: 14px;">
            æ˜¾ç¤º {{ (pagination.page - 1) * pagination.per_page + 1 }} - {{ [pagination.page * pagination.per_page, pagination.total] | min }} 
            å…± {{ pagination.total }} æ¡
        </div>
        
        <div class="pagination">
            {% if pagination.has_prev %}
            <a href="?page={{ pagination.prev_page }}{% if current_team %}&team={{ current_team }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_keyword %}&search={{ search_keyword }}{% endif %}" 
               class="pagination-btn">Â« ä¸Šä¸€é¡µ</a>
            {% else %}
            <span class="pagination-btn pagination-btn-disabled">Â« ä¸Šä¸€é¡µ</span>
            {% endif %}
            
            {% for p in pagination.pages %}
                {% if p == pagination.page %}
                <span class="pagination-btn pagination-btn-active">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}{% if current_team %}&team={{ current_team }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_keyword %}&search={{ search_keyword }}{% endif %}" 
                   class="pagination-btn">{{ p }}</a>
                {% endif %}
            {% endfor %}
            
            {% if pagination.has_next %}
            <a href="?page={{ pagination.next_page }}{% if current_team %}&team={{ current_team }}{% endif %}{% if current_status %}&status={{ current_status }}{% endif %}{% if search_keyword %}&search={{ search_keyword }}{% endif %}" 
               class="pagination-btn">ä¸‹ä¸€é¡µ Â»</a>
            {% else %}
            <span class="pagination-btn pagination-btn-disabled">ä¸‹ä¸€é¡µ Â»</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // åˆ‡æ¢é«˜çº§ç­›é€‰æ˜¾ç¤º/éšè—
    function toggleAdvancedFilters() {
        const advFilters = document.getElementById('advancedFilters');
        const icon = document.getElementById('advancedToggleIcon');
        
        if (advFilters.style.display === 'none' || advFilters.style.display === '') {
            advFilters.style.display = 'block';
            icon.textContent = 'â–²';
        } else {
            advFilters.style.display = 'none';
            icon.textContent = 'â–¼';
        }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰é«˜çº§ç­›é€‰å‚æ•°ï¼Œå¦‚æœæœ‰åˆ™è‡ªåŠ¨å±•å¼€
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const hasAdvancedFilters = 
            urlParams.get('join_date_from') || 
            urlParams.get('join_date_to') ||
            urlParams.get('orders_from') ||
            urlParams.get('orders_to') ||
            urlParams.get('work_days_from') ||
            urlParams.get('work_days_to');
        
        if (hasAdvancedFilters) {
            toggleAdvancedFilters();
        }
    });

    // ========== æ‰¹é‡æ“ä½œåŠŸèƒ½ ==========
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.emp-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateSelection();
    }
    
    // æ›´æ–°é€‰æ‹©çŠ¶æ€
    function updateSelection() {
        const checkboxes = document.querySelectorAll('.emp-checkbox');
        const checked = document.querySelectorAll('.emp-checkbox:checked');
        const batchBar = document.getElementById('batchActionsBar');
        const countSpan = document.getElementById('selectedCount');
        const selectAll = document.getElementById('selectAll');
        
        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        selectAll.checked = checked.length === checkboxes.length && checkboxes.length > 0;
        selectAll.indeterminate = checked.length > 0 && checked.length < checkboxes.length;
        
        // æ˜¾ç¤º/éšè—æ‰¹é‡æ“ä½œæ 
        if (checked.length > 0) {
            batchBar.style.display = 'block';
            countSpan.textContent = checked.length;
        } else {
            batchBar.style.display = 'none';
        }
    }
    
    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        document.querySelectorAll('.emp-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
        updateSelection();
    }
    
    // è·å–é€‰ä¸­çš„å‘˜å·¥IDs
    function getSelectedIds() {
        const checked = document.querySelectorAll('.emp-checkbox:checked');
        return Array.from(checked).map(cb => cb.value);
    }
    
    // æ‰¹é‡å¯¼å‡º
    function batchExport() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©å‘˜å·¥', 'warning');
            return;
        }
        
        // æ„å»ºå¯¼å‡ºURL
        const url = `/export/employees/excel?ids=${ids.join(',')}`;
        window.open(url, '_blank');
        showToast(`æ­£åœ¨å¯¼å‡º${ids.length}åå‘˜å·¥æ•°æ®...`, 'info');
    }
    
    // æ‰¹é‡ä¿®æ”¹å›¢é˜Ÿ
    function batchChangeTeam() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            showToast('è¯·å…ˆé€‰æ‹©å‘˜å·¥', 'warning');
            return;
        }
        
        const team = prompt(`è¯·è¾“å…¥æ–°å›¢é˜Ÿåç§°ï¼ˆå°†ä¿®æ”¹${ids.length}åå‘˜å·¥ï¼‰ï¼š`);
        if (!team) return;
        
        if (!confirmAction(`ç¡®å®šå°†${ids.length}åå‘˜å·¥çš„å›¢é˜Ÿä¿®æ”¹ä¸º"${team}"å—ï¼Ÿ`)) {
            return;
        }
        
        fetch('/admin/batch_change_team', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ids: ids, team: team})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥ï¼š' + error, 'danger');
        });
    }

    function deleteEmployee(id, name) {
        if (!confirmAction(`ç¡®å®šè¦åˆ é™¤å‘˜å·¥"${name}"å—ï¼Ÿåˆ é™¤åè¯¥å‘˜å·¥å°†è¢«æ ‡è®°ä¸ºç¦»èŒã€‚`)) {
            return;
        }
        
        fetch(`/admin/employee/${id}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æ“ä½œå¤±è´¥ï¼š' + error, 'danger');
        });
    }
</script>
{% endblock %}

