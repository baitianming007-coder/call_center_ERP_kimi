{% extends "base.html" %}

{% block title %}è–ªèµ„ç»Ÿè®¡ - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<!-- é¢åŒ…å±‘å¯¼èˆª -->
<nav class="breadcrumb" style="margin-bottom: var(--space-16);">
    <a href="{{ url_for('admin.dashboard') }}">é¦–é¡µ</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">è–ªèµ„ç»Ÿè®¡</span>
</nav>

<div class="flex-between mb-24">
    <div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
            ğŸ’° è–ªèµ„ç»Ÿè®¡
        </h1>
        <p style="color: var(--gray-600);">{{ year_month }} Â· å…± {{ salary_list|length }} åå‘˜å·¥</p>
    </div>
    <a href="{{ url_for('export.export_salary_excel', year_month=year_month) }}" class="btn btn-success">ğŸ“¥ å¯¼å‡ºExcel</a>
</div>

<!-- ç­›é€‰æ  -->
<div class="card mb-24">
    <div class="card-body">
        <form method="GET" id="salarySearchForm">
            <!-- ç¬¬ä¸€è¡Œï¼šæœˆä»½æŸ¥è¯¢ -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">é€‰æ‹©æœˆä»½</label>
                    <input type="month" name="year_month" id="yearMonth" class="form-input" value="{{ year_month }}">
                </div>
                
                <div class="form-group" style="flex: 2; margin: 0;">
                    <label class="form-label">å¿«æ·é€‰æ‹©</label>
                    <div style="display: flex; gap: var(--space-8);">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickMonth('current')">æœ¬æœˆ</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickMonth('last')">ä¸Šæœˆ</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickMonth('last2')">ä¸Šä¸Šæœˆ</button>
                    </div>
                </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šå›¢é˜Ÿå’Œå‘˜å·¥æŸ¥è¯¢ -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">å›¢é˜Ÿ</label>
                    <select name="team" id="teamSelect" class="form-select" onchange="filterEmployees()">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        <option value="Aç»„" {% if filter_team == 'Aç»„' %}selected{% endif %}>Aç»„</option>
                        <option value="Bç»„" {% if filter_team == 'Bç»„' %}selected{% endif %}>Bç»„</option>
                        <option value="Cç»„" {% if filter_team == 'Cç»„' %}selected{% endif %}>Cç»„</option>
                        <option value="Dç»„" {% if filter_team == 'Dç»„' %}selected{% endif %}>Dç»„</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 3; margin: 0;">
                    <label class="form-label">å‘˜å·¥æœç´¢ï¼ˆå·¥å·/å§“åï¼‰</label>
                    <input type="text" id="employeeSearch" class="form-input" placeholder="è¾“å…¥å·¥å·æˆ–å§“åæœç´¢å‘˜å·¥..." onkeyup="searchEmployee()" autocomplete="off">
                    <input type="hidden" name="employee" id="employeeId" value="{{ filter_employee or '' }}">
                    <div id="employeeDropdown" style="display: none; position: absolute; z-index: 100; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-md); margin-top: 4px; max-height: 300px; overflow-y: auto; box-shadow: var(--shadow-lg); min-width: 400px;"></div>
                </div>
                
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">çŠ¶æ€</label>
                    <select name="status" class="form-select">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="trainee" {% if filter_status == 'trainee' %}selected{% endif %}>åŸ¹è®­æœŸ</option>
                        <option value="C" {% if filter_status == 'C' %}selected{% endif %}>Cçº§</option>
                        <option value="B" {% if filter_status == 'B' %}selected{% endif %}>Bçº§</option>
                        <option value="A" {% if filter_status == 'A' %}selected{% endif %}>Açº§</option>
                        <option value="eliminated" {% if filter_status == 'eliminated' %}selected{% endif %}>å·²æ·˜æ±°</option>
                    </select>
                </div>
            </div>
            
            <!-- ç¬¬ä¸‰è¡Œï¼šæ“ä½œæŒ‰é’® -->
            <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                <a href="{{ url_for('admin.salary') }}" class="btn btn-secondary">ğŸ”„ é‡ç½®</a>
                <button type="submit" class="btn btn-primary" style="min-width: 120px;">ğŸ” æŸ¥è¯¢</button>
            </div>
        </form>
    </div>
</div>

<!-- ç»Ÿè®¡æ‘˜è¦ -->
<div class="grid grid-cols-3 mb-24">
    <div class="stat-card">
        <div class="stat-label">æ€»è–ªèµ„</div>
        <div class="stat-value" style="color: var(--color-primary); font-size: 28px;">
            {{ total_salary | format_currency }}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å›ºå®šè–ªèµ„æ€»è®¡</div>
        <div class="stat-value" style="color: var(--color-info); font-size: 24px;">
            {{ total_base | format_currency }}
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ææˆæ€»è®¡</div>
        <div class="stat-value" style="color: var(--color-success); font-size: 24px;">
            {{ total_commission | format_currency }}
        </div>
    </div>
</div>

<!-- è–ªèµ„åˆ—è¡¨ -->
<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>çŠ¶æ€</th>
                    <th>åº•è–ª/å›ºå®š</th>
                    <th>å…¨å‹¤å¥–</th>
                    <th>ç»©æ•ˆå¥–</th>
                    <th>ææˆ</th>
                    <th style="text-align: right;">æ€»è®¡</th>
                    <th style="text-align: center;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% if salary_list %}
                    {% for sal in salary_list %}
                    <tr>
                        <td><strong>{{ sal.employee_no }}</strong></td>
                        <td>{{ sal.name }}</td>
                        <td>{{ sal.team }}</td>
                        <td>
                            <span class="badge badge-{{ sal.status }}">{{ sal.status | status_label }}</span>
                        </td>
                        <td>{{ sal.base_salary | format_currency }}</td>
                        <td>{{ sal.attendance_bonus | format_currency }}</td>
                        <td>{{ sal.performance_bonus | format_currency }}</td>
                        <td style="color: var(--color-success); font-weight: 600;">{{ sal.commission | format_currency }}</td>
                        <td style="text-align: right; font-weight: 700; color: var(--color-primary); font-size: 16px;">
                            {{ sal.total_salary | format_currency }}
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="showDetail('{{ sal.name }}', `{{ sal.calculation_detail }}`)">
                                æŸ¥çœ‹æ˜ç»†
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" style="text-align: center; padding: var(--space-48); color: var(--gray-500);">
                            è¯¥æœˆä»½æš‚æ— è–ªèµ„æ•°æ®
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ˜ç»†å¼¹çª— -->
<div id="detailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-md); max-width: 600px; width: 90%; max-height: 80vh; overflow: auto;">
        <div style="padding: var(--space-24); border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
            <h3 id="detailTitle" style="font-size: 18px; font-weight: 600; margin: 0;">è–ªèµ„è®¡ç®—æ˜ç»†</h3>
            <button onclick="closeDetail()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: var(--gray-600);">&times;</button>
        </div>
        <div style="padding: var(--space-24);">
            <pre id="detailContent" style="white-space: pre-line; line-height: 1.8; color: var(--gray-700); font-size: 14px;"></pre>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æ‰€æœ‰å‘˜å·¥æ•°æ®
    const allEmployees = {{ all_employees | tojson }};
    let filteredEmployees = allEmployees;
    
    // é¡µé¢åŠ è½½æ—¶æ¢å¤å·²é€‰æ‹©çš„å‘˜å·¥
    document.addEventListener('DOMContentLoaded', function() {
        const selectedId = document.getElementById('employeeId').value;
        if (selectedId) {
            const employee = allEmployees.find(e => e.id == selectedId);
            if (employee) {
                document.getElementById('employeeSearch').value = employee.employee_no + ' - ' + employee.name;
            }
        }
    });
    
    // å¿«æ·æœˆä»½é€‰æ‹©
    function setQuickMonth(type) {
        const today = new Date();
        let year = today.getFullYear();
        let month = today.getMonth() + 1;
        
        if (type === 'last') {
            month -= 1;
            if (month < 1) {
                month = 12;
                year -= 1;
            }
        } else if (type === 'last2') {
            month -= 2;
            if (month < 1) {
                month += 12;
                year -= 1;
            }
        }
        
        const monthStr = String(month).padStart(2, '0');
        document.getElementById('yearMonth').value = `${year}-${monthStr}`;
    }
    
    // æ ¹æ®å›¢é˜Ÿç­›é€‰å‘˜å·¥
    function filterEmployees() {
        const team = document.getElementById('teamSelect').value;
        if (team) {
            filteredEmployees = allEmployees.filter(e => e.team === team);
        } else {
            filteredEmployees = allEmployees;
        }
        
        // æ¸…ç©ºå‘˜å·¥æœç´¢
        document.getElementById('employeeSearch').value = '';
        document.getElementById('employeeId').value = '';
        document.getElementById('employeeDropdown').style.display = 'none';
    }
    
    // æœç´¢å‘˜å·¥
    function searchEmployee() {
        const searchText = document.getElementById('employeeSearch').value.toLowerCase();
        const dropdown = document.getElementById('employeeDropdown');
        
        if (searchText.length < 1) {
            dropdown.style.display = 'none';
            document.getElementById('employeeId').value = '';
            return;
        }
        
        // æœç´¢åŒ¹é…
        const matches = filteredEmployees.filter(emp => 
            emp.employee_no.toLowerCase().includes(searchText) || 
            emp.name.toLowerCase().includes(searchText)
        ).slice(0, 50); // æœ€å¤šæ˜¾ç¤º50ä¸ªç»“æœ
        
        if (matches.length === 0) {
            dropdown.innerHTML = '<div style="padding: var(--space-12); color: var(--gray-500); text-align: center;">æœªæ‰¾åˆ°åŒ¹é…çš„å‘˜å·¥</div>';
            dropdown.style.display = 'block';
            return;
        }
        
        // æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
        dropdown.innerHTML = matches.map(emp => `
            <div class="employee-option" onclick="selectEmployee(${emp.id}, '${emp.employee_no}', '${emp.name}')" 
                 style="padding: var(--space-12); cursor: pointer; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong style="color: var(--color-primary);">${emp.employee_no}</strong> - ${emp.name}
                </div>
                <span style="color: var(--gray-500); font-size: 12px;">${emp.team} Â· ${emp.status}</span>
            </div>
        `).join('');
        
        dropdown.style.display = 'block';
        
        // é¼ æ ‡æ‚¬åœæ•ˆæœ
        const options = dropdown.querySelectorAll('.employee-option');
        options.forEach(opt => {
            opt.addEventListener('mouseenter', function() {
                this.style.background = 'var(--gray-50)';
            });
            opt.addEventListener('mouseleave', function() {
                this.style.background = 'white';
            });
        });
    }
    
    // é€‰æ‹©å‘˜å·¥
    function selectEmployee(id, no, name) {
        document.getElementById('employeeId').value = id;
        document.getElementById('employeeSearch').value = no + ' - ' + name;
        document.getElementById('employeeDropdown').style.display = 'none';
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
    document.addEventListener('click', function(e) {
        const search = document.getElementById('employeeSearch');
        const dropdown = document.getElementById('employeeDropdown');
        if (e.target !== search && e.target !== dropdown && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // è–ªèµ„æ˜ç»†å¼¹çª—
    function showDetail(name, detail) {
        document.getElementById('detailTitle').textContent = name + ' çš„è–ªèµ„è®¡ç®—æ˜ç»†';
        document.getElementById('detailContent').textContent = detail;
        document.getElementById('detailModal').style.display = 'flex';
    }
    
    function closeDetail() {
        document.getElementById('detailModal').style.display = 'none';
    }
    
    document.getElementById('detailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDetail();
        }
    });
</script>
{% endblock %}

