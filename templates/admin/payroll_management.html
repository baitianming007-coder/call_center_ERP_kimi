{% extends "base.html" %}
{% block title %}å·¥èµ„ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}
{% block content %}
<div class="page-header">
    <h1>ğŸ’° å·¥èµ„ç®¡ç†</h1>
</div>
<div class="card" style="margin-bottom: var(--space-24);">
    <div class="card-header">
        <h2>{{ year_month }}æœˆå·¥èµ„å•</h2>
        <form method="GET" style="display: inline-block;">
            <input type="month" name="year_month" value="{{ year_month }}" class="form-input" onchange="this.form.submit()">
        </form>
    </div>
    <div class="card-body">
        <div style="margin-bottom: var(--space-16);">
            <button class="btn btn-primary" onclick="previewPayroll()">ğŸ” é¢„è§ˆå·¥èµ„å•</button>
            <button class="btn btn-success" onclick="exportExcel()">å¯¼å‡ºExcel</button>
        </div>
        <div style="margin-bottom: var(--space-16);">
            <span>æ€»è®¡ï¼š{{ total_count }}äºº | æ€»é¢ï¼šÂ¥{{ "%.2f"|format(total_amount) }}</span>
        </div>
        {% if payrolls %}
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th><th>å§“å</th><th>å›¢é˜Ÿ</th><th>åº”å‘</th><th>çŠ¶æ€</th><th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for p in payrolls %}
                <tr>
                    <td>{{ p.employee_no }}</td>
                    <td>{{ p.employee_name }}</td>
                    <td>{{ p.team }}</td>
                    <td>Â¥{{ "%.2f"|format(p.total_salary) }}</td>
                    <td>
                        {% if p.status == 'pending' %}<span class="badge badge-warning">å¾…ç¡®è®¤</span>
                        {% elif p.status == 'confirmed' %}<span class="badge badge-info">å·²ç¡®è®¤</span>
                        {% elif p.status == 'paid' %}<span class="badge badge-success">å·²å‘æ”¾</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="adjustPayroll({{ p.id }}, '{{ p.employee_name }}')">è°ƒæ•´</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state"><p>æš‚æ— å·¥èµ„è®°å½•</p></div>
        {% endif %}
    </div>
</div>

<!-- å·¥èµ„å•é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="previewModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>å·¥èµ„å•é¢„è§ˆ - {{ year_month }}</h3>
            <button class="modal-close" onclick="closePreviewModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="previewContent">
                <div style="text-align: center; padding: var(--space-48);">
                    <div class="spinner"></div>
                    <p style="color: var(--gray-600); margin-top: var(--space-16);">æ­£åœ¨åŠ è½½é¢„è§ˆæ•°æ®...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="confirmGenerate()">âœ“ ç¡®è®¤ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<script>
// é¢„è§ˆå·¥èµ„å•
function previewPayroll() {
    const modal = document.getElementById('previewModal');
    const content = document.getElementById('previewContent');
    
    modal.style.display = 'flex';
    
    // åŠ è½½é¢„è§ˆæ•°æ®
    fetch(`/admin/api/payroll_preview?year_month={{ year_month }}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPreview(data);
            } else {
                content.innerHTML = `
                    <div style="text-align: center; padding: var(--space-48);">
                        <p style="color: var(--color-danger);">âŒ ${data.message || 'åŠ è½½å¤±è´¥'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            content.innerHTML = `
                <div style="text-align: center; padding: var(--space-48);">
                    <p style="color: var(--color-danger);">âŒ åŠ è½½å¤±è´¥: ${error}</p>
                </div>
            `;
        });
}

// æ¸²æŸ“é¢„è§ˆå†…å®¹
function renderPreview(data) {
    const content = document.getElementById('previewContent');
    
    let html = `
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div style="background: var(--gray-50); padding: var(--space-20); border-radius: var(--radius-sm); margin-bottom: var(--space-24);">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-16); text-align: center;">
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--color-primary);">${data.total_count}</div>
                    <div style="color: var(--gray-600); font-size: 13px; margin-top: 4px;">å‘˜å·¥äººæ•°</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--color-success);">Â¥${data.total_amount.toFixed(2)}</div>
                    <div style="color: var(--gray-600); font-size: 13px; margin-top: 4px;">å·¥èµ„æ€»é¢</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--color-info);">Â¥${data.avg_salary.toFixed(2)}</div>
                    <div style="color: var(--gray-600); font-size: 13px; margin-top: 4px;">å¹³å‡å·¥èµ„</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 700; color: var(--color-warning);">Â¥${data.commission_total.toFixed(2)}</div>
                    <div style="color: var(--gray-600); font-size: 13px; margin-top: 4px;">ææˆæ€»é¢</div>
                </div>
            </div>
        </div>
        
        <!-- é¢„è§ˆæç¤º -->
        <div style="background: var(--color-info); color: white; padding: var(--space-12) var(--space-16); border-radius: var(--radius-sm); margin-bottom: var(--space-16); font-size: 14px;">
            ğŸ’¡ é¢„è§ˆæ˜¾ç¤ºå‰10æ¡è®°å½•ï¼Œç¡®è®¤åå°†ç”Ÿæˆå…¨éƒ¨${data.total_count}æ¡å·¥èµ„å•
        </div>
        
        <!-- é¢„è§ˆè¡¨æ ¼ -->
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>çŠ¶æ€</th>
                    <th>åº•è–ª</th>
                    <th>å…¨å‹¤</th>
                    <th>ç»©æ•ˆ</th>
                    <th>ææˆ</th>
                    <th>åº”å‘</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.preview.forEach(p => {
        html += `
            <tr>
                <td>${p.employee_no}</td>
                <td>${p.employee_name}</td>
                <td>${p.team || '-'}</td>
                <td><span class="badge badge-${getStatusBadge(p.status_at_time)}">${getStatusLabel(p.status_at_time)}</span></td>
                <td>Â¥${p.base_salary.toFixed(2)}</td>
                <td>Â¥${p.attendance_bonus.toFixed(2)}</td>
                <td>Â¥${p.performance_bonus.toFixed(2)}</td>
                <td>Â¥${p.commission.toFixed(2)}</td>
                <td><strong>Â¥${p.total_salary.toFixed(2)}</strong></td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        
        ${data.total_count > 10 ? '<p style="text-align: center; color: var(--gray-600); margin-top: var(--space-16);">è¿˜æœ‰ ' + (data.total_count - 10) + ' æ¡è®°å½•æœªæ˜¾ç¤º...</p>' : ''}
    `;
    
    content.innerHTML = html;
}

// çŠ¶æ€æ ‡ç­¾
function getStatusLabel(status) {
    const labels = {'trainee': 'åŸ¹è®­æœŸ', 'C': 'Cçº§', 'B': 'Bçº§', 'A': 'Açº§', 'eliminated': 'å·²æ·˜æ±°'};
    return labels[status] || status;
}

function getStatusBadge(status) {
    const badges = {'trainee': 'secondary', 'C': 'warning', 'B': 'info', 'A': 'success', 'eliminated': 'danger'};
    return badges[status] || 'secondary';
}

// å…³é—­é¢„è§ˆ
function closePreviewModal() {
    document.getElementById('previewModal').style.display = 'none';
}

// ç¡®è®¤ç”Ÿæˆ
function confirmGenerate() {
    closePreviewModal();
    if(confirm('ç¡®è®¤ç”Ÿæˆå·¥èµ„å•å—ï¼Ÿå¦‚å·²å­˜åœ¨å°†è¦†ç›–ã€‚')) {
        document.location = '{{ url_for("admin_ext.generate_payroll") }}?year_month={{ year_month }}&overwrite=1';
    }
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.getElementById('previewModal').addEventListener('click', function(e) {
    if (e.target === this) closePreviewModal();
});

function adjustPayroll(id, name) {
    alert('è°ƒæ•´åŠŸèƒ½è¯·åœ¨è¯¦æƒ…é¡µæ“ä½œ');
}
function exportExcel() {
    alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­');
}
</script>

<style>
.spinner {
    border: 3px solid var(--gray-200);
    border-top: 3px solid var(--color-primary);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

{% endblock %}
