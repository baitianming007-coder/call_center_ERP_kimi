{% extends "base.html" %}

{% block title %}å½•å…¥ä¸šç»© - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="mb-24">
    <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900);">
        âœï¸ å½•å…¥ä¸šç»©
    </h1>
</div>

<div class="card" style="max-width: 700px;">
    <form id="performanceForm" style="padding: var(--space-32);">
        <div class="form-group">
            <label class="form-label required">å‘˜å·¥</label>
            <select name="employee_id" id="employee_id" class="form-select" required>
                <option value="">è¯·é€‰æ‹©å‘˜å·¥</option>
                {% for emp in employees %}
                <option value="{{ emp.id }}">{{ emp.employee_no }} - {{ emp.name }} ({{ emp.team }})</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label required">æ—¥æœŸ</label>
            <input type="date" name="work_date" id="work_date" class="form-input" required>
        </div>
        <script>
            // è®¾ç½®é»˜è®¤å€¼ä¸ºä»Šå¤©
            document.getElementById('work_date').valueAsDate = new Date();
        </script>
        
        <div class="form-group">
            <label class="form-label required">å‡ºå•æ•°</label>
            <input type="number" name="orders_count" id="orders_count" class="form-input" min="0" value="0" required onchange="calculateCommission()">
            <div id="commissionPreview" style="margin-top: var(--space-8); font-size: 13px; color: var(--color-success);"></div>
        </div>
        
        <div class="form-group">
            <label class="form-label">æ˜¯å¦æœ‰æ•ˆå·¥ä½œæ—¥</label>
            <div style="display: flex; gap: var(--space-16); align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="is_valid_workday" value="1" checked style="margin-right: 8px;">
                    <span>æ˜¯</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="is_valid_workday" value="0" style="margin-right: 8px;">
                    <span>å¦</span>
                </label>
            </div>
        </div>
        
        <div style="display: flex; gap: var(--space-12); justify-content: flex-end; margin-top: var(--space-32);">
            <a href="{{ url_for('admin.performance') }}" class="btn btn-secondary">å–æ¶ˆ</a>
            <button type="submit" class="btn btn-primary">æäº¤</button>
        </div>
    </form>
</div>

<!-- ææˆè®¡ç®—è§„åˆ™ -->
<div class="card mt-24" style="max-width: 700px;">
    <div class="card-header">
        <h3>ğŸ’¡ ææˆè®¡ç®—è§„åˆ™</h3>
    </div>
    <div class="card-body">
        <ul style="list-style: none; padding: 0; margin: 0; color: var(--gray-700); font-size: 14px; line-height: 1.8;">
            <li>â€¢ 1-3å•ï¼š<strong>10å…ƒ/å•</strong></li>
            <li>â€¢ 4-5å•ï¼š<strong>20å…ƒ/å•</strong></li>
            <li>â€¢ â‰¥6å•ï¼š<strong>30å…ƒ/å•</strong></li>
        </ul>
        <div style="margin-top: var(--space-12); padding: var(--space-12); background: var(--gray-50); border-radius: var(--radius-sm); font-size: 13px; color: var(--gray-600);">
            ä¾‹ï¼šå½•å…¥7å• = å‰3å•(30å…ƒ) + ç¬¬4-5å•(40å…ƒ) + ç¬¬6-7å•(60å…ƒ) = 130å…ƒ
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function calculateCommission() {
        const orders = parseInt(document.getElementById('orders_count').value) || 0;
        let commission = 0;
        
        if (orders <= 3) {
            commission = orders * 10;
        } else if (orders <= 5) {
            commission = 3 * 10 + (orders - 3) * 20;
        } else {
            commission = 3 * 10 + 2 * 20 + (orders - 5) * 30;
        }
        
        document.getElementById('commissionPreview').textContent = 
            orders > 0 ? `é¢„è®¡ææˆï¼šÂ¥${commission.toFixed(2)}` : '';
    }
    
    document.getElementById('performanceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{{ url_for("admin.performance_add") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // é‡ç½®è¡¨å•
                this.reset();
                document.getElementById('commissionPreview').textContent = '';
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æäº¤å¤±è´¥ï¼š' + error, 'danger');
        });
    });
    
    // åˆå§‹è®¡ç®—
    calculateCommission();
</script>
{% endblock %}

