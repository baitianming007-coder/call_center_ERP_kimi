{% extends "base.html" %}
{% block title %}å·¥ä½œæ—¥é…ç½® - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    .calendar-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-20);
        padding: var(--space-16);
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .toolbar-left {
        display: flex;
        align-items: center;
        gap: var(--space-16);
    }
    
    .mode-selector {
        display: flex;
        gap: var(--space-8);
    }
    
    .mode-btn {
        padding: 8px 16px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
    }
    
    .mode-btn.active {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }
    
    .mode-btn:hover:not(.active) {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .calendar-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .calendar-table th {
        background: #667eea;
        color: white;
        padding: var(--space-12);
        font-weight: 600;
        text-align: center;
    }
    
    .calendar-cell {
        padding: 0;
        height: 100px;
        border: 1px solid #e0e0e0;
        position: relative;
        vertical-align: top;
    }
    
    .calendar-day {
        width: 100%;
        height: 100%;
        padding: var(--space-8);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: white;
        border: 3px solid transparent;
    }
    
    .calendar-day.workday {
        background: #d4edda;
    }
    
    .calendar-day.holiday {
        background: #f8d7da;
    }
    
    .calendar-day.selected {
        border: 3px solid #ffc107;
        box-shadow: inset 0 0 8px rgba(255,193,7,0.5);
    }
    
    .calendar-day:hover {
        transform: scale(1.02);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 1;
    }
    
    .day-number {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .day-label {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
    }
    
    .day-label.workday {
        background: #28a745;
        color: white;
    }
    
    .day-label.holiday {
        background: #dc3545;
        color: white;
    }
    
    .action-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #667eea;
        padding: var(--space-16);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        display: none;
        z-index: 1000;
    }
    
    .action-bar.active {
        display: block;
    }
    
    .action-bar-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .action-info {
        font-size: 16px;
        font-weight: 600;
        color: #333;
    }
    
    .action-buttons {
        display: flex;
        gap: var(--space-12);
    }
    
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 2000;
        align-items: center;
        justify-content: center;
    }
    
    .modal-overlay.active {
        display: flex;
    }
    
    .modal {
        background: white;
        border-radius: 12px;
        padding: var(--space-24);
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .modal-header {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: var(--space-16);
        color: #333;
    }
    
    .modal-body {
        margin-bottom: var(--space-20);
        line-height: 1.6;
    }
    
    .modal-checkbox {
        display: flex;
        align-items: center;
        gap: var(--space-8);
        padding: var(--space-12);
        background: #f8f9fa;
        border-radius: 6px;
        margin-top: var(--space-12);
    }
    
    .modal-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .modal-footer {
        display: flex;
        gap: var(--space-12);
        justify-content: flex-end;
    }
    
    .legend {
        display: flex;
        gap: var(--space-20);
        margin-top: var(--space-16);
        padding: var(--space-12);
        background: #f8f9fa;
        border-radius: 6px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: var(--space-8);
    }
    
    .legend-box {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 2px solid #ddd;
    }
</style>

<div class="page-header">
    <h1>ğŸ“… å·¥ä½œæ—¥é…ç½®</h1>
    <p style="color: var(--gray-600); margin-top: var(--space-8);">é…ç½®ç³»ç»Ÿå·¥ä½œæ—¥å’Œå‡æœŸï¼Œæ”¯æŒæ‰¹é‡é€‰æ‹©</p>
</div>

<div class="calendar-container">
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <label style="font-weight: 600;">é€‰æ‹©æœˆä»½ï¼š</label>
            <input type="month" 
                   id="monthSelector" 
                   value="{{ '%04d-%02d'|format(year, month) }}" 
                   class="form-input"
                   style="width: 200px;">
            
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="workday" onclick="setMode('workday')">
                    ğŸŸ¢ è®¾ä¸ºå·¥ä½œæ—¥
                </button>
                <button class="mode-btn" data-mode="holiday" onclick="setMode('holiday')">
                    ğŸ”´ è®¾ä¸ºå‡æœŸ
                </button>
            </div>
        </div>
        
        <button class="btn btn-secondary" onclick="clearSelection()">
            æ¸…é™¤é€‰æ‹©
        </button>
    </div>
    
    <!-- å›¾ä¾‹ -->
    <div class="legend">
        <div class="legend-item">
            <div class="legend-box" style="background: #d4edda;"></div>
            <span>å·¥ä½œæ—¥</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: #f8d7da;"></div>
            <span>å‡æœŸ</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background: white;"></div>
            <span>æœªé…ç½®</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="border: 3px solid #ffc107;"></div>
            <span>å·²é€‰æ‹©</span>
        </div>
    </div>
    
    <!-- æ—¥å†è¡¨æ ¼ -->
    <div style="margin-top: var(--space-20);">
        <table class="calendar-table">
            <thead>
                <tr>
                    <th>å‘¨ä¸€</th>
                    <th>å‘¨äºŒ</th>
                    <th>å‘¨ä¸‰</th>
                    <th>å‘¨å››</th>
                    <th>å‘¨äº”</th>
                    <th>å‘¨å…­</th>
                    <th>å‘¨æ—¥</th>
                </tr>
            </thead>
            <tbody>
                {% for week in calendar_data %}
                <tr>
                    {% for day in week %}
                    <td class="calendar-cell">
                        {% if day != 0 %}
                            {% set date_str = "%04d-%02d-%02d"|format(year, month, day) %}
                            {% set config = config_dict.get(date_str) %}
                            {% set is_workday = config.is_workday if config else None %}
                            
                            <div class="calendar-day {% if is_workday == 1 %}workday{% elif is_workday == 0 %}holiday{% endif %}"
                                 data-date="{{ date_str }}"
                                 data-current-state="{% if is_workday == 1 %}workday{% elif is_workday == 0 %}holiday{% else %}unset{% endif %}"
                                 onclick="toggleDate('{{ date_str }}', this)">
                                <div class="day-number">{{ day }}</div>
                                {% if is_workday == 1 %}
                                    <span class="day-label workday">å·¥ä½œæ—¥</span>
                                {% elif is_workday == 0 %}
                                    <span class="day-label holiday">å‡æœŸ</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- åº•éƒ¨æ“ä½œæ  -->
<div id="actionBar" class="action-bar">
    <div class="action-bar-content">
        <div class="action-info">
            å·²é€‰æ‹© <strong id="selectedCount">0</strong> å¤©
        </div>
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="cancelSelection()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="showConfirmModal()">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<!-- ç¡®è®¤å¯¹è¯æ¡† -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">ç¡®è®¤é…ç½®</div>
        <div class="modal-body">
            <p id="confirmMessage"></p>
            <div class="modal-checkbox">
                <input type="checkbox" id="recalculateCheckbox" checked>
                <label for="recalculateCheckbox" style="cursor: pointer; user-select: none;">
                    é‡æ–°è®¡ç®—è¯¥æœˆä»½æ‰€æœ‰å‘˜å·¥çš„ä¸šç»©æ•°æ®ï¼ˆæ¨èï¼‰
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideConfirmModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitConfiguration()">ç¡®è®¤</button>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let selectedDates = new Set();
let currentMode = 'workday'; // 'workday' or 'holiday'
let currentYear = {{ year }};
let currentMonth = {{ month }};

// è®¾ç½®æ“ä½œæ¨¡å¼
function setMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(btn => {
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// åˆ‡æ¢æ—¥æœŸé€‰æ‹©
function toggleDate(dateStr, element) {
    if (selectedDates.has(dateStr)) {
        selectedDates.delete(dateStr);
        element.classList.remove('selected');
    } else {
        selectedDates.add(dateStr);
        element.classList.add('selected');
    }
    updateActionBar();
}

// æ›´æ–°æ“ä½œæ 
function updateActionBar() {
    const actionBar = document.getElementById('actionBar');
    const selectedCount = document.getElementById('selectedCount');
    
    selectedCount.textContent = selectedDates.size;
    
    if (selectedDates.size > 0) {
        actionBar.classList.add('active');
    } else {
        actionBar.classList.remove('active');
    }
}

// æ¸…é™¤é€‰æ‹©
function clearSelection() {
    selectedDates.clear();
    document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
    });
    updateActionBar();
}

// å–æ¶ˆé€‰æ‹©
function cancelSelection() {
    clearSelection();
}

// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
function showConfirmModal() {
    if (selectedDates.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦é…ç½®çš„æ—¥æœŸ');
        return;
    }
    
    const modeText = currentMode === 'workday' ? 'å·¥ä½œæ—¥' : 'å‡æœŸ';
    const message = `ç¡®è®¤å°†é€‰ä¸­çš„ ${selectedDates.size} å¤©è®¾ç½®ä¸º${modeText}å—ï¼Ÿ`;
    
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmModal').classList.add('active');
}

// éšè—ç¡®è®¤å¯¹è¯æ¡†
function hideConfirmModal() {
    document.getElementById('confirmModal').classList.remove('active');
}

// æäº¤é…ç½®
async function submitConfiguration() {
    const recalculate = document.getElementById('recalculateCheckbox').checked;
    
    const data = {
        dates: Array.from(selectedDates),
        is_workday: currentMode === 'workday',
        recalculate_performance: recalculate,
        year_month: `${currentYear}-${String(currentMonth).padStart(2, '0')}`
    };
    
    try {
        const response = await fetch('{{ url_for("admin_ext.batch_save_workdays") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ›´æ–°ç•Œé¢
            selectedDates.forEach(dateStr => {
                const element = document.querySelector(`[data-date="${dateStr}"]`);
                if (element) {
                    // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                    element.classList.remove('workday', 'holiday', 'selected');
                    
                    // æ·»åŠ æ–°çŠ¶æ€
                    if (currentMode === 'workday') {
                        element.classList.add('workday');
                    } else {
                        element.classList.add('holiday');
                    }
                    
                    // æ›´æ–°æ ‡ç­¾
                    const labelHtml = currentMode === 'workday' 
                        ? '<span class="day-label workday">å·¥ä½œæ—¥</span>'
                        : '<span class="day-label holiday">å‡æœŸ</span>';
                    
                    const dayNumber = element.querySelector('.day-number').outerHTML;
                    element.innerHTML = dayNumber + labelHtml;
                }
            });
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            let message = `æˆåŠŸé…ç½® ${result.affected_dates} å¤©`;
            if (result.affected_employees > 0) {
                message += `ï¼Œå·²é‡æ–°è®¡ç®— ${result.affected_employees} åå‘˜å·¥çš„ä¸šç»©`;
            }
            
            showSuccessToast(message);
            
            // æ¸…é™¤é€‰æ‹©
            clearSelection();
            hideConfirmModal();
        } else {
            alert('é…ç½®å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        alert('ç½‘ç»œé”™è¯¯ï¼š' + error.message);
    }
}

// æ˜¾ç¤ºæˆåŠŸæç¤º
function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 3000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = 'âœ“ ' + message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// æœˆä»½é€‰æ‹©å™¨å˜åŒ–
document.getElementById('monthSelector').addEventListener('change', function() {
    const yearMonth = this.value;
    window.location.href = '{{ url_for("admin_ext.work_calendar") }}?year_month=' + yearMonth;
});

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}
