{% extends "base.html" %}

{% block title %}ä¸šç»©ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<!-- é¢åŒ…å±‘å¯¼èˆª -->
<nav class="breadcrumb" style="margin-bottom: var(--space-16);">
    <a href="{{ url_for('admin.dashboard') }}">é¦–é¡µ</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">ä¸šç»©ç®¡ç†</span>
</nav>

<div class="flex-between mb-24">
    <div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
            ğŸ“ˆ ä¸šç»©ç®¡ç†
        </h1>
        <p style="color: var(--gray-600);">{{ filter_date }} Â· å…± {{ performance_list|length }} æ¡è®°å½•</p>
    </div>
    <div style="display: flex; gap: var(--space-12);">
        <a href="{{ url_for('export.export_performance_excel', date=filter_date) }}" class="btn btn-secondary">ğŸ“¥ å¯¼å‡ºExcel</a>
        <a href="{{ url_for('admin.performance_import') }}" class="btn btn-info">ğŸ“¤ Excelå¯¼å…¥</a>
        <a href="{{ url_for('admin.performance_add') }}" class="btn btn-primary">+ å•æ¡å½•å…¥</a>
        <a href="{{ url_for('admin.performance_batch') }}" class="btn btn-success">ğŸ“ æ‰¹é‡å½•å…¥</a>
    </div>
</div>

<!-- ç­›é€‰æ  -->
<div class="card mb-24">
    <div class="card-body">
        <form method="GET" id="performanceSearchForm">
            <!-- ç¬¬ä¸€è¡Œï¼šæ—¥æœŸæŸ¥è¯¢ -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">æŸ¥è¯¢æ¨¡å¼</label>
                    <select id="dateMode" class="form-select" onchange="toggleDateMode()">
                        <option value="single" {% if not date_start or not date_end or date_start == date_end %}selected{% endif %}>å•æ—¥æŸ¥è¯¢</option>
                        <option value="range" {% if date_start and date_end and date_start != date_end %}selected{% endif %}>æ—¥æœŸåŒºé—´</option>
                    </select>
                </div>
                
                <div class="form-group" id="singleDateGroup" style="flex: 2; margin: 0;">
                    <label class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                    <input type="date" name="date" id="singleDate" class="form-input" value="{{ filter_date }}">
                </div>
                
                <div class="form-group" id="dateRangeGroup" style="flex: 2; margin: 0; display: none;">
                    <label class="form-label">æ—¥æœŸèŒƒå›´</label>
                    <div style="display: flex; gap: var(--space-8); align-items: center;">
                        <input type="date" name="date_start" id="dateStart" class="form-input" value="{{ date_start or '' }}">
                        <span>è‡³</span>
                        <input type="date" name="date_end" id="dateEnd" class="form-input" value="{{ date_end or '' }}">
                    </div>
                </div>
                
                <div class="form-group" style="flex: 2; margin: 0;">
                    <label class="form-label">å¿«æ·é€‰æ‹©</label>
                    <div style="display: flex; gap: var(--space-8);">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('today')">ä»Šæ—¥</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('yesterday')">æ˜¨æ—¥</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('week')">æœ¬å‘¨</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('month')">æœ¬æœˆ</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('last_month')">ä¸Šæœˆ</button>
                    </div>
                </div>
            </div>
            
            <!-- ç¬¬äºŒè¡Œï¼šå›¢é˜Ÿå’Œå‘˜å·¥æŸ¥è¯¢ -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">å›¢é˜Ÿ</label>
                    <select name="team" id="teamSelect" class="form-select" onchange="filterEmployees()">
                        <option value="">å…¨éƒ¨å›¢é˜Ÿ</option>
                        <option value="Aç»„" {% if filter_team == 'Aç»„' %}selected{% endif %}>Aç»„</option>
                        <option value="Bç»„" {% if filter_team == 'Bç»„' %}selected{% endif %}>Bç»„</option>
                        <option value="Cç»„" {% if filter_team == 'Cç»„' %}selected{% endif %}>Cç»„</option>
                        <option value="Dç»„" {% if filter_team == 'Dç»„' %}selected{% endif %}>Dç»„</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 3; margin: 0;">
                    <label class="form-label">å‘˜å·¥æœç´¢ï¼ˆå·¥å·/å§“åï¼‰</label>
                    <input type="text" id="employeeSearch" class="form-input" placeholder="è¾“å…¥å·¥å·æˆ–å§“åæœç´¢å‘˜å·¥..." onkeyup="searchEmployee()" autocomplete="off">
                    <input type="hidden" name="employee" id="employeeId" value="{{ filter_employee or '' }}">
                    <div id="employeeDropdown" style="display: none; position: absolute; z-index: 100; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-md); margin-top: 4px; max-height: 300px; overflow-y: auto; box-shadow: var(--shadow-lg); min-width: 400px;"></div>
                </div>
                
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">çŠ¶æ€</label>
                    <select name="status" class="form-select">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="trainee" {% if filter_status == 'trainee' %}selected{% endif %}>åŸ¹è®­æœŸ</option>
                        <option value="C" {% if filter_status == 'C' %}selected{% endif %}>Cçº§</option>
                        <option value="B" {% if filter_status == 'B' %}selected{% endif %}>Bçº§</option>
                        <option value="A" {% if filter_status == 'A' %}selected{% endif %}>Açº§</option>
                        <option value="eliminated" {% if filter_status == 'eliminated' %}selected{% endif %}>å·²æ·˜æ±°</option>
                    </select>
                </div>
            </div>
            
            <!-- ç¬¬ä¸‰è¡Œï¼šæ“ä½œæŒ‰é’® -->
            <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                <a href="{{ url_for('admin.performance') }}" class="btn btn-secondary">ğŸ”„ é‡ç½®</a>
                <button type="submit" class="btn btn-primary" style="min-width: 120px;">ğŸ” æŸ¥è¯¢</button>
            </div>
        </form>
    </div>
</div>

<!-- ç»Ÿè®¡æ‘˜è¦ -->
<div class="grid grid-cols-3 mb-24">
    <div class="stat-card">
        <div class="stat-label">æ€»å‡ºå•æ•°</div>
        <div class="stat-value" style="color: var(--color-primary);">{{ total_orders }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æ€»ææˆ</div>
        <div class="stat-value" style="color: var(--color-success); font-size: 24px;">{{ total_commission | format_currency }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">å¹³å‡å‡ºå•</div>
        <div class="stat-value" style="color: var(--color-info);">
            {{ '%.1f'|format(total_orders / performance_list|length if performance_list else 0) }}
        </div>
    </div>
</div>

<!-- ä¸šç»©åˆ—è¡¨ -->
<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>å·¥å·</th>
                    <th>å§“å</th>
                    <th>å›¢é˜Ÿ</th>
                    <th>çŠ¶æ€</th>
                    <th>å‡ºå•æ•°</th>
                    <th>æ—¥ææˆ</th>
                    <th>æœ‰æ•ˆå·¥ä½œæ—¥</th>
                    <th>æ—¥æœŸ</th>
                </tr>
            </thead>
            <tbody>
                {% if performance_list %}
                    {% for perf in performance_list %}
                    <tr>
                        <td><strong>{{ perf.employee_no }}</strong></td>
                        <td>{{ perf.name }}</td>
                        <td>{{ perf.team }}</td>
                        <td>
                            <span class="badge badge-{{ perf.status }}">{{ perf.status | status_label }}</span>
                        </td>
                        <td><strong style="color: var(--color-primary); font-size: 16px;">{{ perf.orders_count }}</strong></td>
                        <td><strong style="color: var(--color-success);">{{ perf.commission | format_currency }}</strong></td>
                        <td>
                            {% if perf.is_valid_workday %}
                                <span class="badge badge-success">æ˜¯</span>
                            {% else %}
                                <span class="badge" style="background: rgba(156, 163, 175, 0.15); color: var(--gray-600);">å¦</span>
                            {% endif %}
                        </td>
                        <td>{{ perf.work_date }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: var(--space-48); color: var(--gray-500);">
                            è¯¥æ—¥æœŸæš‚æ— ä¸šç»©æ•°æ®
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ‰€æœ‰å‘˜å·¥æ•°æ®
const allEmployees = {{ employees | tojson }};
let filteredEmployees = allEmployees;

// åˆ‡æ¢æ—¥æœŸæ¨¡å¼
function toggleDateMode() {
    const mode = document.getElementById('dateMode').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const rangeGroup = document.getElementById('dateRangeGroup');
    
    if (mode === 'single') {
        singleGroup.style.display = 'block';
        rangeGroup.style.display = 'none';
        // æ¸…ç©ºåŒºé—´è¾“å…¥
        document.getElementById('dateStart').value = '';
        document.getElementById('dateEnd').value = '';
    } else {
        singleGroup.style.display = 'none';
        rangeGroup.style.display = 'block';
        // æ¸…ç©ºå•æ—¥è¾“å…¥
        document.getElementById('singleDate').value = '';
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ¨¡å¼
document.addEventListener('DOMContentLoaded', function() {
    toggleDateMode();
    
    // æ¢å¤å·²é€‰æ‹©çš„å‘˜å·¥
    const selectedId = document.getElementById('employeeId').value;
    if (selectedId) {
        const employee = allEmployees.find(e => e.id == selectedId);
        if (employee) {
            document.getElementById('employeeSearch').value = employee.employee_no + ' - ' + employee.name;
        }
    }
});

// å¿«æ·æ—¥æœŸé€‰æ‹©
function setQuickDate(type) {
    const today = new Date();
    const dateMode = document.getElementById('dateMode');
    
    if (type === 'today') {
        dateMode.value = 'single';
        toggleDateMode();
        document.getElementById('singleDate').value = formatDate(today);
    } else if (type === 'yesterday') {
        dateMode.value = 'single';
        toggleDateMode();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('singleDate').value = formatDate(yesterday);
    } else if (type === 'week') {
        dateMode.value = 'range';
        toggleDateMode();
        const monday = new Date(today);
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´åˆ°å‘¨ä¸€
        monday.setDate(diff);
        document.getElementById('dateStart').value = formatDate(monday);
        document.getElementById('dateEnd').value = formatDate(today);
    } else if (type === 'month') {
        dateMode.value = 'range';
        toggleDateMode();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('dateStart').value = formatDate(firstDay);
        document.getElementById('dateEnd').value = formatDate(today);
    } else if (type === 'last_month') {
        dateMode.value = 'range';
        toggleDateMode();
        const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
        document.getElementById('dateStart').value = formatDate(firstDay);
        document.getElementById('dateEnd').value = formatDate(lastDay);
    }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// æ ¹æ®å›¢é˜Ÿç­›é€‰å‘˜å·¥
function filterEmployees() {
    const team = document.getElementById('teamSelect').value;
    if (team) {
        filteredEmployees = allEmployees.filter(e => e.team === team);
    } else {
        filteredEmployees = allEmployees;
    }
    
    // æ¸…ç©ºå‘˜å·¥æœç´¢
    document.getElementById('employeeSearch').value = '';
    document.getElementById('employeeId').value = '';
    document.getElementById('employeeDropdown').style.display = 'none';
}

// æœç´¢å‘˜å·¥
function searchEmployee() {
    const searchText = document.getElementById('employeeSearch').value.toLowerCase();
    const dropdown = document.getElementById('employeeDropdown');
    
    if (searchText.length < 1) {
        dropdown.style.display = 'none';
        document.getElementById('employeeId').value = '';
        return;
    }
    
    // æœç´¢åŒ¹é…
    const matches = filteredEmployees.filter(emp => 
        emp.employee_no.toLowerCase().includes(searchText) || 
        emp.name.toLowerCase().includes(searchText)
    ).slice(0, 50); // æœ€å¤šæ˜¾ç¤º50ä¸ªç»“æœ
    
    if (matches.length === 0) {
        dropdown.innerHTML = '<div style="padding: var(--space-12); color: var(--gray-500); text-align: center;">æœªæ‰¾åˆ°åŒ¹é…çš„å‘˜å·¥</div>';
        dropdown.style.display = 'block';
        return;
    }
    
    // æ¸²æŸ“ä¸‹æ‹‰åˆ—è¡¨
    dropdown.innerHTML = matches.map(emp => `
        <div class="employee-option" onclick="selectEmployee(${emp.id}, '${emp.employee_no}', '${emp.name}')" 
             style="padding: var(--space-12); cursor: pointer; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong style="color: var(--color-primary);">${emp.employee_no}</strong> - ${emp.name}
            </div>
            <span style="color: var(--gray-500); font-size: 12px;">${emp.team} Â· ${emp.status}</span>
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
    
    // é¼ æ ‡æ‚¬åœæ•ˆæœ
    const options = dropdown.querySelectorAll('.employee-option');
    options.forEach(opt => {
        opt.addEventListener('mouseenter', function() {
            this.style.background = 'var(--gray-50)';
        });
        opt.addEventListener('mouseleave', function() {
            this.style.background = 'white';
        });
    });
}

// é€‰æ‹©å‘˜å·¥
function selectEmployee(id, no, name) {
    document.getElementById('employeeId').value = id;
    document.getElementById('employeeSearch').value = no + ' - ' + name;
    document.getElementById('employeeDropdown').style.display = 'none';
}

// ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
document.addEventListener('click', function(e) {
    const search = document.getElementById('employeeSearch');
    const dropdown = document.getElementById('employeeDropdown');
    if (e.target !== search && e.target !== dropdown && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});
</script>
{% endblock %}
