{% extends "base.html" %}

{% block title %}业绩管理 - 呼叫中心管理系统{% endblock %}

{% block content %}
<!-- 面包屑导航 -->
<nav class="breadcrumb" style="margin-bottom: var(--space-16);">
    <a href="{{ url_for('admin.dashboard') }}">首页</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">业绩管理</span>
</nav>

<div class="flex-between mb-24">
    <div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
            📈 业绩管理
        </h1>
        <p style="color: var(--gray-600);">{{ filter_date }} · 共 {{ performance_list|length }} 条记录</p>
    </div>
    <div style="display: flex; gap: var(--space-12);">
        <a href="{{ url_for('export.export_performance_excel', date=filter_date) }}" class="btn btn-secondary">📥 导出Excel</a>
        <a href="{{ url_for('admin.performance_import') }}" class="btn btn-info">📤 Excel导入</a>
        <a href="{{ url_for('admin.performance_add') }}" class="btn btn-primary">+ 单条录入</a>
        <a href="{{ url_for('admin.performance_batch') }}" class="btn btn-success">📝 批量录入</a>
    </div>
</div>

<!-- 筛选栏 -->
<div class="card mb-24">
    <div class="card-body">
        <form method="GET" id="performanceSearchForm">
            <!-- 第一行：日期查询 -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">查询模式</label>
                    <select id="dateMode" class="form-select" onchange="toggleDateMode()">
                        <option value="single" {% if not date_start or not date_end or date_start == date_end %}selected{% endif %}>单日查询</option>
                        <option value="range" {% if date_start and date_end and date_start != date_end %}selected{% endif %}>日期区间</option>
                    </select>
                </div>
                
                <div class="form-group" id="singleDateGroup" style="flex: 2; margin: 0;">
                    <label class="form-label">选择日期</label>
                    <input type="date" name="date" id="singleDate" class="form-input" value="{{ filter_date }}">
                </div>
                
                <div class="form-group" id="dateRangeGroup" style="flex: 2; margin: 0; display: none;">
                    <label class="form-label">日期范围</label>
                    <div style="display: flex; gap: var(--space-8); align-items: center;">
                        <input type="date" name="date_start" id="dateStart" class="form-input" value="{{ date_start or '' }}">
                        <span>至</span>
                        <input type="date" name="date_end" id="dateEnd" class="form-input" value="{{ date_end or '' }}">
                    </div>
                </div>
                
                <div class="form-group" style="flex: 2; margin: 0;">
                    <label class="form-label">快捷选择</label>
                    <div style="display: flex; gap: var(--space-8);">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('today')">今日</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('yesterday')">昨日</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('week')">本周</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('month')">本月</button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="setQuickDate('last_month')">上月</button>
                    </div>
                </div>
            </div>
            
            <!-- 第二行：团队和员工查询 -->
            <div style="display: flex; gap: var(--space-16); margin-bottom: var(--space-16);">
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">团队</label>
                    <select name="team" id="teamSelect" class="form-select" onchange="filterEmployees()">
                        <option value="">全部团队</option>
                        <option value="A组" {% if filter_team == 'A组' %}selected{% endif %}>A组</option>
                        <option value="B组" {% if filter_team == 'B组' %}selected{% endif %}>B组</option>
                        <option value="C组" {% if filter_team == 'C组' %}selected{% endif %}>C组</option>
                        <option value="D组" {% if filter_team == 'D组' %}selected{% endif %}>D组</option>
                    </select>
                </div>
                
                <div class="form-group" style="flex: 3; margin: 0;">
                    <label class="form-label">员工搜索（工号/姓名）</label>
                    <input type="text" id="employeeSearch" class="form-input" placeholder="输入工号或姓名搜索员工..." onkeyup="searchEmployee()" autocomplete="off">
                    <input type="hidden" name="employee" id="employeeId" value="{{ filter_employee or '' }}">
                    <div id="employeeDropdown" style="display: none; position: absolute; z-index: 100; background: white; border: 1px solid var(--gray-300); border-radius: var(--radius-md); margin-top: 4px; max-height: 300px; overflow-y: auto; box-shadow: var(--shadow-lg); min-width: 400px;"></div>
                </div>
                
                <div class="form-group" style="flex: 1; margin: 0;">
                    <label class="form-label">状态</label>
                    <select name="status" class="form-select">
                        <option value="">全部状态</option>
                        <option value="trainee" {% if filter_status == 'trainee' %}selected{% endif %}>培训期</option>
                        <option value="C" {% if filter_status == 'C' %}selected{% endif %}>C级</option>
                        <option value="B" {% if filter_status == 'B' %}selected{% endif %}>B级</option>
                        <option value="A" {% if filter_status == 'A' %}selected{% endif %}>A级</option>
                        <option value="eliminated" {% if filter_status == 'eliminated' %}selected{% endif %}>已淘汰</option>
                    </select>
                </div>
            </div>
            
            <!-- 第三行：操作按钮 -->
            <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                <a href="{{ url_for('admin.performance') }}" class="btn btn-secondary">🔄 重置</a>
                <button type="submit" class="btn btn-primary" style="min-width: 120px;">🔍 查询</button>
            </div>
        </form>
    </div>
</div>

<!-- 统计摘要 -->
<div class="grid grid-cols-3 mb-24">
    <div class="stat-card">
        <div class="stat-label">总出单数</div>
        <div class="stat-value" style="color: var(--color-primary);">{{ total_orders }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">总提成</div>
        <div class="stat-value" style="color: var(--color-success); font-size: 24px;">{{ total_commission | format_currency }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">平均出单</div>
        <div class="stat-value" style="color: var(--color-info);">
            {{ '%.1f'|format(total_orders / performance_list|length if performance_list else 0) }}
        </div>
    </div>
</div>

<!-- 业绩列表 -->
<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>工号</th>
                    <th>姓名</th>
                    <th>团队</th>
                    <th>状态</th>
                    <th>出单数</th>
                    <th>日提成</th>
                    <th>有效工作日</th>
                    <th>日期</th>
                </tr>
            </thead>
            <tbody>
                {% if performance_list %}
                    {% for perf in performance_list %}
                    <tr>
                        <td><strong>{{ perf.employee_no }}</strong></td>
                        <td>{{ perf.name }}</td>
                        <td>{{ perf.team }}</td>
                        <td>
                            <span class="badge badge-{{ perf.status }}">{{ perf.status | status_label }}</span>
                        </td>
                        <td><strong style="color: var(--color-primary); font-size: 16px;">{{ perf.orders_count }}</strong></td>
                        <td><strong style="color: var(--color-success);">{{ perf.commission | format_currency }}</strong></td>
                        <td>
                            {% if perf.is_valid_workday %}
                                <span class="badge badge-success">是</span>
                            {% else %}
                                <span class="badge" style="background: rgba(156, 163, 175, 0.15); color: var(--gray-600);">否</span>
                            {% endif %}
                        </td>
                        <td>{{ perf.work_date }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" style="text-align: center; padding: var(--space-48); color: var(--gray-500);">
                            该日期暂无业绩数据
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 所有员工数据
const allEmployees = {{ employees | tojson }};
let filteredEmployees = allEmployees;

// 切换日期模式
function toggleDateMode() {
    const mode = document.getElementById('dateMode').value;
    const singleGroup = document.getElementById('singleDateGroup');
    const rangeGroup = document.getElementById('dateRangeGroup');
    
    if (mode === 'single') {
        singleGroup.style.display = 'block';
        rangeGroup.style.display = 'none';
        // 清空区间输入
        document.getElementById('dateStart').value = '';
        document.getElementById('dateEnd').value = '';
    } else {
        singleGroup.style.display = 'none';
        rangeGroup.style.display = 'block';
        // 清空单日输入
        document.getElementById('singleDate').value = '';
    }
}

// 页面加载时检查模式
document.addEventListener('DOMContentLoaded', function() {
    toggleDateMode();
    
    // 恢复已选择的员工
    const selectedId = document.getElementById('employeeId').value;
    if (selectedId) {
        const employee = allEmployees.find(e => e.id == selectedId);
        if (employee) {
            document.getElementById('employeeSearch').value = employee.employee_no + ' - ' + employee.name;
        }
    }
});

// 快捷日期选择
function setQuickDate(type) {
    const today = new Date();
    const dateMode = document.getElementById('dateMode');
    
    if (type === 'today') {
        dateMode.value = 'single';
        toggleDateMode();
        document.getElementById('singleDate').value = formatDate(today);
    } else if (type === 'yesterday') {
        dateMode.value = 'single';
        toggleDateMode();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        document.getElementById('singleDate').value = formatDate(yesterday);
    } else if (type === 'week') {
        dateMode.value = 'range';
        toggleDateMode();
        const monday = new Date(today);
        const day = today.getDay();
        const diff = today.getDate() - day + (day === 0 ? -6 : 1); // 调整到周一
        monday.setDate(diff);
        document.getElementById('dateStart').value = formatDate(monday);
        document.getElementById('dateEnd').value = formatDate(today);
    } else if (type === 'month') {
        dateMode.value = 'range';
        toggleDateMode();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('dateStart').value = formatDate(firstDay);
        document.getElementById('dateEnd').value = formatDate(today);
    } else if (type === 'last_month') {
        dateMode.value = 'range';
        toggleDateMode();
        const firstDay = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth(), 0);
        document.getElementById('dateStart').value = formatDate(firstDay);
        document.getElementById('dateEnd').value = formatDate(lastDay);
    }
}

// 格式化日期
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// 根据团队筛选员工
function filterEmployees() {
    const team = document.getElementById('teamSelect').value;
    if (team) {
        filteredEmployees = allEmployees.filter(e => e.team === team);
    } else {
        filteredEmployees = allEmployees;
    }
    
    // 清空员工搜索
    document.getElementById('employeeSearch').value = '';
    document.getElementById('employeeId').value = '';
    document.getElementById('employeeDropdown').style.display = 'none';
}

// 搜索员工
function searchEmployee() {
    const searchText = document.getElementById('employeeSearch').value.toLowerCase();
    const dropdown = document.getElementById('employeeDropdown');
    
    if (searchText.length < 1) {
        dropdown.style.display = 'none';
        document.getElementById('employeeId').value = '';
        return;
    }
    
    // 搜索匹配
    const matches = filteredEmployees.filter(emp => 
        emp.employee_no.toLowerCase().includes(searchText) || 
        emp.name.toLowerCase().includes(searchText)
    ).slice(0, 50); // 最多显示50个结果
    
    if (matches.length === 0) {
        dropdown.innerHTML = '<div style="padding: var(--space-12); color: var(--gray-500); text-align: center;">未找到匹配的员工</div>';
        dropdown.style.display = 'block';
        return;
    }
    
    // 渲染下拉列表
    dropdown.innerHTML = matches.map(emp => `
        <div class="employee-option" onclick="selectEmployee(${emp.id}, '${emp.employee_no}', '${emp.name}')" 
             style="padding: var(--space-12); cursor: pointer; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong style="color: var(--color-primary);">${emp.employee_no}</strong> - ${emp.name}
            </div>
            <span style="color: var(--gray-500); font-size: 12px;">${emp.team} · ${emp.status}</span>
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
    
    // 鼠标悬停效果
    const options = dropdown.querySelectorAll('.employee-option');
    options.forEach(opt => {
        opt.addEventListener('mouseenter', function() {
            this.style.background = 'var(--gray-50)';
        });
        opt.addEventListener('mouseleave', function() {
            this.style.background = 'white';
        });
    });
}

// 选择员工
function selectEmployee(id, no, name) {
    document.getElementById('employeeId').value = id;
    document.getElementById('employeeSearch').value = no + ' - ' + name;
    document.getElementById('employeeDropdown').style.display = 'none';
}

// 点击外部关闭下拉框
document.addEventListener('click', function(e) {
    const search = document.getElementById('employeeSearch');
    const dropdown = document.getElementById('employeeDropdown');
    if (e.target !== search && e.target !== dropdown && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});
</script>
{% endblock %}
