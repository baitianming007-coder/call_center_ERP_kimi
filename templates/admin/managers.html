{% extends "base.html" %}

{% block title %}è´¦å·ç®¡ç† - å‘¼å«ä¸­å¿ƒç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="flex-between mb-24">
    <div>
        <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-8);">
            ğŸ‘¤ ç®¡ç†å‘˜è´¦å·ç®¡ç†
        </h1>
        <p style="color: var(--gray-600);">å…± {{ managers|length }} ä¸ªç®¡ç†å‘˜è´¦å·</p>
    </div>
    <button class="btn btn-primary" onclick="showAddManager()">+ æ·»åŠ è´¦å·</button>
</div>

<!-- è´¦å·åˆ—è¡¨ -->
<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>è§’è‰²</th>
                    <th>å…³è”å‘˜å·¥ID</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th style="text-align: right;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for manager in managers %}
                <tr>
                    <td><strong>{{ manager.username }}</strong></td>
                    <td>
                        {% if manager.role == 'admin' %}
                            <span class="badge" style="background: rgba(239, 68, 68, 0.15); color: var(--color-danger);">ç®¡ç†å‘˜</span>
                        {% else %}
                            <span class="badge badge-warning">ç»ç†</span>
                        {% endif %}
                    </td>
                    <td>{{ manager.employee_id or '-' }}</td>
                    <td>{{ manager.created_at }}</td>
                    <td class="actions">
                        {% if manager.id != user.id %}
                            <button class="btn btn-sm btn-danger" onclick="deleteManager({{ manager.id }}, '{{ manager.username }}')">
                                åˆ é™¤
                            </button>
                        {% else %}
                            <span style="color: var(--gray-400); font-size: 13px;">å½“å‰è´¦å·</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- æ·»åŠ è´¦å·å¼¹çª— -->
<div id="addManagerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-md); max-width: 500px; width: 90%;">
        <div style="padding: var(--space-24); border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 18px; font-weight: 600; margin: 0;">æ·»åŠ ç®¡ç†å‘˜è´¦å·</h3>
            <button onclick="closeAddManager()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: var(--gray-600);">&times;</button>
        </div>
        <div style="padding: var(--space-24);">
            <form id="managerForm" onsubmit="addManager(event)">
                <div class="form-group">
                    <label class="form-label required">ç”¨æˆ·å</label>
                    <input type="text" id="username" class="form-input" placeholder="ç™»å½•ç”¨æˆ·å" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">å¯†ç </label>
                    <input type="password" id="password" class="form-input" placeholder="åˆå§‹å¯†ç " required minlength="6">
                    <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">å¯†ç é•¿åº¦è‡³å°‘6ä½</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label required">è§’è‰²</label>
                    <select id="role" class="form-select" required>
                        <option value="manager">ç»ç†ï¼ˆé™å›¢é˜Ÿæ•°æ®ï¼‰</option>
                        <option value="admin">ç®¡ç†å‘˜ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: var(--space-12); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddManager()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function showAddManager() {
        document.getElementById('addManagerModal').style.display = 'flex';
        document.getElementById('managerForm').reset();
    }
    
    function closeAddManager() {
        document.getElementById('addManagerModal').style.display = 'none';
    }
    
    function addManager(event) {
        event.preventDefault();
        
        const formData = new FormData();
        formData.append('username', document.getElementById('username').value);
        formData.append('password', document.getElementById('password').value);
        formData.append('role', document.getElementById('role').value);
        
        fetch('{{ url_for("admin.manager_add") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('æ·»åŠ å¤±è´¥ï¼š' + error, 'danger');
        });
    }
    
    function deleteManager(id, username) {
        if (!confirmAction(`ç¡®å®šè¦åˆ é™¤ç®¡ç†å‘˜è´¦å·"${username}"å—ï¼Ÿ`)) {
            return;
        }
        
        fetch(`/admin/manager/${id}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message, 'danger');
            }
        })
        .catch(error => {
            showToast('åˆ é™¤å¤±è´¥ï¼š' + error, 'danger');
        });
    }
    
    document.getElementById('addManagerModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddManager();
        }
    });
</script>
{% endblock %}



